<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>FundFinder - AI-Powered Funding Opportunities</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      /* CSS Variables for Orange Design System */
      :root {
        --color-white: #ffffff;
        --color-orange: #ff8c42; /* Softer orange */
        --color-orange-medium: #ffa366;
        --color-orange-light: #ffc8a8;
        --color-orange-very-light: #ffe8db;
        --color-dark: #333333;
        --color-gray: #666666;
        --color-gray-light: #f5f5f5;
        --color-gray-border: #e0e0e0;
        --font-heading: "Archivo Black", sans-serif;
        --font-body: "Archivo", sans-serif;
        --border-radius-sm: 4px;
        --border-radius-md: 8px;
        --border-radius-lg: 12px;
        --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.08);
        --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.12);
        --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.15);
        --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: var(--font-body);
        line-height: 1.6;
        color: var(--color-dark);
        background: var(--color-gray-light);
      }

      /* Header */
      .header {
        background: var(--color-white);
        padding: 1rem 2rem;
        border-bottom: 2px solid var(--color-orange);
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: var(--shadow-sm);
      }

      .logo {
        font-weight: 700;
        font-size: 1.8rem;
        color: var(--color-orange);
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-family: var(--font-heading);
      }

      .nav-links {
        display: flex;
        gap: 2rem;
        align-items: center;
      }

      .nav-links a {
        color: var(--color-dark);
        text-decoration: none;
        font-weight: 600;
        padding: 0.5rem 1rem;
        border-radius: var(--border-radius-md);
        transition: var(--transition);
        position: relative;
      }

      .nav-links a:hover,
      .nav-links a.active {
        color: var(--color-orange);
      }

      .nav-links a.active::after {
        content: "";
        position: absolute;
        bottom: -2px;
        left: 1rem;
        right: 1rem;
        height: 3px;
        background: var(--color-orange);
        border-radius: var(--border-radius-sm);
      }

      .user-menu {
        display: flex;
        align-items: center;
        gap: 1rem;
      }

      .user-info {
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .user-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: linear-gradient(
          135deg,
          var(--color-orange),
          var(--color-orange-medium)
        );
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 600;
      }

      .logout-btn {
        background: #ff4757;
        color: white;
        border: none;
        padding: 0.6rem 1.2rem;
        border-radius: var(--border-radius-md);
        cursor: pointer;
        font-weight: 600;
        transition: var(--transition);
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .logout-btn:hover {
        background: #ff3742;
        transform: translateY(-2px);
      }

      /* Main Content */
      .main-content {
        max-width: 1200px;
        margin: 0 auto;
        padding: 2rem;
      }

      .page-header {
        text-align: center;
        margin-bottom: 3rem;
      }

      .page-header h1 {
        color: var(--color-orange);
        font-size: 2.5rem;
        margin-bottom: 0.5rem;
        font-family: var(--font-heading);
      }

      .page-header p {
        color: var(--color-gray);
        font-size: 1.2rem;
      }

      /* Profile Summary */
      .profile-summary {
        background: var(--color-white);
        padding: 2rem;
        border-radius: var(--border-radius-lg);
        box-shadow: var(--shadow-md);
        margin-bottom: 2rem;
        border-left: 4px solid var(--color-orange);
      }

      .profile-summary h2 {
        color: var(--color-orange);
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-family: var(--font-heading);
      }

      .criteria-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-top: 1rem;
      }

      .criteria-item {
        padding: 1rem;
        background: var(--color-gray-light);
        border-radius: var(--border-radius-md);
        border-left: 4px solid var(--color-orange);
      }

      .criteria-item strong {
        color: var(--color-dark);
        display: block;
        margin-bottom: 0.25rem;
        font-size: 0.9rem;
      }

      .profile-actions {
        margin-top: 1.5rem;
        text-align: right;
      }

      /* AI Matching Section */
      .ai-matching-header {
        background: linear-gradient(
          135deg,
          var(--color-orange) 0%,
          var(--color-orange-medium) 100%
        );
        color: white;
        padding: 2rem;
        border-radius: var(--border-radius-lg);
        margin-bottom: 2rem;
        box-shadow: var(--shadow-md);
        text-align: center;
      }

      .ai-matching-header h2 {
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        font-family: var(--font-heading);
      }

      .matching-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 1rem;
        margin-top: 1.5rem;
      }

      .stat-item {
        background: rgba(255, 255, 255, 0.1);
        padding: 1rem;
        border-radius: var(--border-radius-md);
        text-align: center;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        transition: var(--transition);
      }

      .stat-item:hover {
        background: rgba(255, 255, 255, 0.15);
        transform: translateY(-2px);
      }

      .stat-value {
        font-size: 1.5rem;
        font-weight: 700;
        margin-bottom: 0.25rem;
      }

      .stat-label {
        font-size: 0.9rem;
        opacity: 0.9;
      }

      /* Funding Opportunities */
      .opportunities-container {
        display: grid;
        gap: 1.5rem;
      }

      .opportunity-card {
        background: var(--color-white);
        border-radius: var(--border-radius-lg);
        box-shadow: var(--shadow-md);
        padding: 2rem;
        transition: var(--transition);
        border: 2px solid transparent;
        position: relative;
      }

      .opportunity-card:hover {
        transform: translateY(-5px);
        box-shadow: var(--shadow-lg);
      }

      .opportunity-card.high-match {
        border-color: #10b981;
      }

      .opportunity-card.medium-match {
        border-color: #f59e0b;
      }

      .opportunity-card.low-match {
        border-color: #ef4444;
      }

      .opportunity-badge {
        position: absolute;
        top: -10px;
        right: 20px;
        background: var(--color-orange);
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 15px;
        font-size: 0.8rem;
        font-weight: 600;
      }

      .opportunity-badge.special {
        background: #8b5cf6;
      }

      .opportunity-badge.regional {
        background: #06b6d4;
      }

      .opportunity-badge.sector {
        background: #10b981;
      }

      .opportunity-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 1.5rem;
      }

      .opportunity-title {
        flex: 1;
      }

      .opportunity-title h3 {
        color: var(--color-orange);
        margin-bottom: 0.5rem;
        font-size: 1.4rem;
        font-family: var(--font-heading);
      }

      .match-badge {
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-weight: 600;
        font-size: 0.9rem;
        white-space: nowrap;
      }

      .match-badge.high {
        background: #10b981;
      }
      .match-badge.medium {
        background: #f59e0b;
      }
      .match-badge.low {
        background: #ef4444;
      }

      .opportunity-details {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 1.5rem;
      }

      .detail-item {
        padding: 0.75rem;
        background: var(--color-gray-light);
        border-radius: var(--border-radius-md);
      }

      .detail-item strong {
        color: var(--color-gray);
        font-size: 0.9rem;
        display: block;
        margin-bottom: 0.25rem;
      }

      .match-analysis {
        background: #e6f7ee;
        border: 1px solid #a3e9c0;
        border-radius: var(--border-radius-md);
        padding: 1rem;
        margin-bottom: 1.5rem;
      }

      .match-analysis h4 {
        color: #0a7b3e;
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-family: var(--font-heading);
      }

      .match-reasons {
        color: #0a7b3e;
        line-height: 1.6;
      }

      .ai-suggestions {
        background: #e6f3ff;
        border: 1px solid #a3d0ff;
        border-radius: var(--border-radius-md);
        padding: 1rem;
        margin-bottom: 1.5rem;
      }

      .ai-suggestions h4 {
        color: #1e40af;
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-family: var(--font-heading);
      }

      .ai-suggestions ul {
        list-style: none;
        padding-left: 0;
        color: #1e40af;
      }

      .ai-suggestions li {
        padding: 0.25rem 0;
        display: flex;
        align-items: flex-start;
        gap: 0.5rem;
      }

      .ai-suggestions li i {
        margin-top: 0.2rem;
        flex-shrink: 0;
      }

      .opportunity-actions {
        display: flex;
        gap: 1rem;
        justify-content: flex-end;
      }

      .btn {
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: var(--border-radius-md);
        font-weight: 600;
        cursor: pointer;
        transition: var(--transition);
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        text-align: center;
        font-family: var(--font-body);
      }

      .btn-primary {
        background: var(--color-orange);
        color: white;
      }

      .btn-primary:hover {
        background: var(--color-orange-medium);
        transform: translateY(-2px);
        box-shadow: var(--shadow-sm);
      }

      .btn-secondary {
        background: var(--color-gray-light);
        color: var(--color-dark);
        border: 2px solid var(--color-gray-border);
      }

      .btn-secondary:hover {
        /* background: var(--color-orange-very-light); */
        /* border-color: var(--color-orange); */
        transform: translateY(-2px);
      }

      .btn-small {
        padding: 0.5rem 1rem;
        font-size: 0.9rem;
      }

      .loading {
        text-align: center;
        padding: 3rem;
      }

      .spinner {
        border: 4px solid rgba(0, 0, 0, 0.1);
        border-left-color: var(--color-orange);
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 1rem;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      .no-results {
        text-align: center;
        padding: 3rem;
        background: var(--color-white);
        border-radius: var(--border-radius-lg);
        box-shadow: var(--shadow-md);
      }

      .criteria-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-top: 1rem;
      }

      .criteria-tag {
        background: var(--color-orange-very-light);
        color: var(--color-orange);
        padding: 0.25rem 0.75rem;
        border-radius: 15px;
        font-size: 0.8rem;
        font-weight: 500;
      }

      .funding-type-indicator {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        margin-top: 0.5rem;
        font-size: 0.9rem;
        color: var(--color-gray);
      }

      .funding-type-indicator i {
        color: var(--color-orange);
      }

      /* Application Modal Styles */
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        align-items: center;
        justify-content: center;
        padding: 1rem;
      }

      .modal.active {
        display: flex;
      }

      .modal-content {
        background: var(--color-white);
        padding: 2rem;
        border-radius: var(--border-radius-lg);
        width: 90%;
        max-width: 700px;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: var(--shadow-lg);
      }

      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid var(--color-gray-border);
      }

      .modal-header h2 {
        color: var(--color-orange);
        font-size: 1.5rem;
        font-family: var(--font-heading);
      }

      .close-modal {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: var(--color-gray);
        padding: 0.5rem;
        transition: var(--transition);
      }

      .close-modal:hover {
        color: var(--color-dark);
      }

      .application-info {
        background: var(--color-gray-light);
        padding: 1rem;
        border-radius: var(--border-radius-md);
        margin-bottom: 1.5rem;
        border-left: 4px solid var(--color-orange);
      }

      .application-info h3 {
        color: var(--color-orange);
        margin-bottom: 0.5rem;
        font-family: var(--font-heading);
      }

      .form-group {
        margin-bottom: 1.5rem;
      }

      .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 600;
        color: var(--color-dark);
      }

      .form-group input,
      .form-group textarea {
        width: 100%;
        padding: 0.75rem;
        border: 2px solid var(--color-gray-border);
        border-radius: var(--border-radius-md);
        font-size: 1rem;
        transition: var(--transition);
        background: var(--color-gray-light);
        font-family: var(--font-body);
      }

      .form-group input:focus,
      .form-group textarea:focus {
        outline: none;
        border-color: var(--color-orange);
        background: var(--color-white);
        box-shadow: 0 0 0 3px rgba(255, 140, 66, 0.1);
      }

      .form-group textarea {
        resize: vertical;
        min-height: 100px;
      }

      .ai-generated-section {
        background: #f0f9ff;
        border: 1px solid #bae6fd;
        border-radius: var(--border-radius-md);
        padding: 1rem;
        margin-bottom: 1rem;
      }

      .ai-generated-section h4 {
        color: #0369a1;
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-family: var(--font-heading);
      }

      .ai-generated-text {
        background: #f8fafc;
        padding: 1rem;
        border-radius: var(--border-radius-sm);
        min-height: 120px;
        white-space: pre-wrap;
        border: 1px solid var(--color-gray-border);
        font-size: 0.9rem;
        line-height: 1.6;
      }
      .ai-generated-text.editable {
        background: var(--color-white) !important;
        /* border: 2px solid var(--color-orange) !important; */
        resize: vertical;
        font-family: var(--font-body);
        font-size: 0.9rem;
        line-height: 1.6;
        padding: 1rem;
        border-radius: var(--border-radius-sm);
        min-height: 120px;
        width: 100%;
        box-sizing: border-box;
        white-space: pre-wrap;
      }

      .ai-generated-text.editable:focus {
        outline: none;
        /* border-color: var(--color-orange); */
        box-shadow: 0 0 0 3px rgba(255, 140, 66, 0.1);
      }

      /* File Upload Styles */
      .file-upload-section {
        margin-bottom: 1.5rem;
      }

      .file-upload-area {
        border: 2px dashed #cbd5e1;
        border-radius: var(--border-radius-md);
        padding: 2rem;
        text-align: center;
        background: #f8fafc;
        transition: var(--transition);
        cursor: pointer;
      }

      .file-upload-area:hover {
        border-color: var(--color-orange);
        background: #f0f9ff;
      }

      .file-upload-area.dragover {
        border-color: var(--color-orange);
        background: #e0f2fe;
      }

      .file-upload-icon {
        font-size: 2rem;
        color: #64748b;
        margin-bottom: 1rem;
      }

      .file-input {
        display: none;
      }

      .file-list {
        margin-top: 1rem;
        max-height: 200px;
        overflow-y: auto;
      }

      .file-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0.75rem;
        background: var(--color-white);
        border: 1px solid #e2e8f0;
        border-radius: var(--border-radius-sm);
        margin-bottom: 0.5rem;
      }

      .file-info {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        flex: 1;
      }

      .file-icon {
        color: #ef4444;
        font-size: 1.2rem;
      }

      .file-name {
        font-weight: 500;
        color: #374151;
      }

      .file-size {
        color: #6b7280;
        font-size: 0.8rem;
      }

      .file-remove {
        background: none;
        border: none;
        color: #ef4444;
        cursor: pointer;
        padding: 0.25rem;
        border-radius: var(--border-radius-sm);
        transition: var(--transition);
      }

      .file-remove:hover {
        background: #fef2f2;
      }

      .upload-hint {
        color: #6b7280;
        font-size: 0.8rem;
        margin-top: 0.5rem;
      }

      .terms-checkbox {
        display: flex;
        align-items: flex-start;
        gap: 0.5rem;
        margin-bottom: 1.5rem;
      }

      .terms-checkbox input {
        margin-top: 0.2rem;
      }

      .terms-checkbox label {
        font-size: 0.9rem;
        color: var(--color-gray);
        line-height: 1.4;
      }

      .form-actions {
        display: flex;
        gap: 1rem;
      }

      .btn-full {
        width: 100%;
        justify-content: center;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .opportunity-card {
        animation: fadeIn 0.5s ease-in;
      }
      @media (max-width: 768px) {
        .header {
          flex-direction: column;
          gap: 1rem;
          padding: 1rem;
        }

        .nav-links {
          gap: 0.5rem;
        }

        .nav-links a {
          padding: 0.5rem;
          font-size: 0.9rem;
        }

        .main-content {
          padding: 1rem;
        }

        .opportunity-header {
          flex-direction: column;
          gap: 1rem;
        }

        .opportunity-actions {
          flex-direction: column;
        }

        .criteria-grid {
          grid-template-columns: 1fr;
        }

        .matching-stats {
          grid-template-columns: repeat(2, 1fr);
        }

        .modal-content {
          padding: 1.5rem;
        }

        .form-actions {
          flex-direction: column;
        }

        .file-upload-area {
          padding: 1.5rem;
        }

        .page-header h1 {
          font-size: 2rem;
        }
      }

      @media (max-width: 480px) {
        .profile-summary,
        .ai-matching-header,
        .opportunity-card {
          padding: 1.5rem;
        }

        .matching-stats {
          grid-template-columns: 1fr;
        }

        .opportunity-details {
          grid-template-columns: 1fr;
        }

        .btn {
          padding: 0.875rem 1.25rem;
          font-size: 0.9rem;
        }
        /* Details Modal Styles */
        .modal-body {
          padding: 0;
        }

        .details-section {
          padding: 1.5rem;
          border-bottom: 1px solid var(--color-gray-border);
        }

        .details-section:last-child {
          border-bottom: none;
        }

        .details-section h3 {
          color: var(--color-orange);
          margin-bottom: 1rem;
          font-family: var(--font-heading);
          display: flex;
          align-items: center;
          gap: 0.5rem;
        }

        .detail-grid {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
          gap: 1rem;
          margin-bottom: 1rem;
        }

        .detail-item {
          display: flex;
          flex-direction: column;
          gap: 0.25rem;
        }

        .detail-label {
          font-weight: 600;
          color: var(--color-gray);
          font-size: 0.9rem;
        }

        .detail-value {
          color: var(--color-dark);
          font-weight: 500;
        }

        .requirements-list {
          list-style: none;
          padding: 0;
        }

        .requirements-list li {
          padding: 0.5rem 0;
          display: flex;
          align-items: flex-start;
          gap: 0.5rem;
          border-bottom: 1px solid var(--color-gray-light);
        }

        .requirements-list li:last-child {
          border-bottom: none;
        }

        .requirements-list li i {
          color: var(--color-orange);
          margin-top: 0.2rem;
        }

        .match-highlights {
          background: var(--color-orange-very-light);
          border-radius: var(--border-radius-md);
          padding: 1rem;
          margin: 1rem 0;
        }

        .match-highlights h4 {
          color: var(--color-orange);
          margin-bottom: 0.5rem;
        }
      }
    </style>
  </head>
  <body>
    <!-- Header -->
    <div class="header">
      <div class="logo">
        <i class="fas fa-hand-holding-usd"></i>
        FundFinder
      </div>
      <div class="nav-links">
        <a href="smme-dashboard.html">Dashboard</a>
        <a href="smme-profile.html">My Profile</a>
        <a href="smme-funding-opportunities.html" class="active"
          >Find Opportunities</a
        >
        <a href="smme-applications.html">My Applications</a>
      </div>
      <div class="user-menu">
        <div class="user-info">
          <div class="user-avatar" id="user-avatar">S</div>
          <div class="user-details">
            <div class="user-name" id="userName">Welcome!</div>
          </div>
        </div>
        <button class="logout-btn" onclick="logout()">
          <i class="fas fa-sign-out-alt"></i> Logout
        </button>
      </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
      <div class="page-header">
        <h1>ü§ñ AI-Powered Funding Matches</h1>
        <p>
          Our AI analyzes your business criteria to find the perfect funding
          opportunities
        </p>
      </div>

      <!-- Business Profile Summary -->
      <div class="profile-summary">
        <h2><i class="fas fa-building"></i> Your Business Criteria</h2>
        <div id="profileCriteria">
          <!-- Will be populated by JavaScript -->
        </div>
        <div class="profile-actions">
          <a href="smme-profile.html" class="btn btn-secondary btn-small">
            <i class="fas fa-edit"></i> Update Criteria
          </a>
        </div>
      </div>

      <!-- AI Matching Header -->
      <div
        class="ai-matching-header"
        id="aiMatchingHeader"
        style="display: none"
      >
        <h2><i class="fas fa-robot"></i> AI Matching Results</h2>
        <p>
          Based on your business criteria, here are your best funding matches
        </p>
        <div class="matching-stats" id="matchingStats">
          <!-- Stats will be populated here -->
        </div>
      </div>

      <!-- Funding Opportunities -->
      <div class="opportunities-container" id="opportunitiesContainer">
        <div class="loading" id="loading">
          <div class="spinner"></div>
          <p>
            ü§ñ AI is analyzing your criteria and finding the best funding
            matches...
          </p>
          <p>
            <small
              >This may take a few moments as we analyze criteria
              matching</small
            >
          </p>
        </div>
      </div>
    </div>
    <!-- View Details Modal -->
    <div id="detailsModal" class="modal">
      <div class="modal-content" style="max-width: 800px">
        <div class="modal-header">
          <h2 id="detailsModalTitle">Funding Opportunity Details</h2>
          <button class="close-modal" onclick="closeDetailsModal()">
            &times;
          </button>
        </div>
        <div class="modal-body" id="detailsModalBody">
          <!-- Details will be populated here -->
        </div>
        <div
          class="modal-actions"
          style="
            padding: 1.5rem;
            border-top: 1px solid var(--color-gray-border);
          "
        >
          <button class="btn btn-secondary" onclick="closeDetailsModal()">
            Close
          </button>
          <button class="btn btn-primary" id="applyFromDetailsBtn">
            <i class="fas fa-paper-plane"></i> Apply Now
          </button>
        </div>
      </div>
    </div>
    <!-- Application Modal -->
    <div id="applicationModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2 id="modalTitle">Apply for Funding</h2>
          <button class="close-modal" onclick="closeApplicationModal()">
            &times;
          </button>
        </div>

        <div class="application-info" id="applicationInfo">
          <!-- Funding opportunity info will be loaded here -->
        </div>

        <form id="applicationForm">
          <div class="form-group">
            <label for="requestedAmount">Requested Amount (ZAR) *</label>
            <input
              type="number"
              id="requestedAmount"
              name="requestedAmount"
              required
              placeholder="Enter the amount you're requesting"
            />
          </div>

          <!-- AI-Generated Project Summary -->
          <!-- AI-Generated Project Summary -->
          <div class="ai-generated-section">
            <h4><i class="fas fa-robot"></i> AI-Generated Project Summary</h4>
            <textarea
              class="ai-generated-text editable"
              id="projectSummaryText"
              placeholder="AI is generating your project summary..."
            ></textarea>
            <button
              type="button"
              class="btn btn-secondary btn-full"
              onclick="regenerateProjectSummary()"
              style="margin-top: 0.5rem"
            >
              <i class="fas fa-sync-alt"></i> Regenerate Project Summary
            </button>
          </div>

          <!-- AI-Generated Motivation Letter -->
          <div class="ai-generated-section">
            <h4><i class="fas fa-robot"></i> AI-Generated Motivation Letter</h4>
            <textarea
              class="ai-generated-text editable"
              id="motivationText"
              placeholder="AI is generating your motivation letter..."
            ></textarea>
            <button
              type="button"
              class="btn btn-secondary btn-full"
              onclick="regenerateMotivation()"
              style="margin-top: 0.5rem"
            >
              <i class="fas fa-sync-alt"></i> Regenerate Motivation Letter
            </button>
          </div>

          <!-- File Upload Section -->
          <div class="file-upload-section">
            <label>Supporting Documents (PDF files only)</label>
            <div
              class="file-upload-area"
              id="fileUploadArea"
              onclick="document.getElementById('fileInput').click()"
            >
              <div class="file-upload-icon">
                <i class="fas fa-cloud-upload-alt"></i>
              </div>
              <h4>Upload Supporting Documents</h4>
              <p>Click to browse or drag and drop PDF files here</p>
              <p class="upload-hint">
                Maximum 5 files ‚Ä¢ PDF only ‚Ä¢ 10MB per file
              </p>
              <input
                type="file"
                id="fileInput"
                class="file-input"
                accept=".pdf"
                multiple
                onchange="handleFileSelect(event)"
              />
            </div>
            <div class="file-list" id="fileList">
              <!-- Uploaded files will appear here -->
            </div>
          </div>

          <div class="terms-checkbox">
            <input
              type="checkbox"
              id="termsAccepted"
              name="termsAccepted"
              required
            />
            <label for="termsAccepted">
              I accept the terms and conditions and confirm the information
              provided is accurate. I understand that this application will be
              reviewed by the funding provider and that supporting documents are
              for review purposes only.
            </label>
          </div>

          <div class="form-actions">
            <button
              type="button"
              class="btn btn-secondary btn-full"
              onclick="closeApplicationModal()"
            >
              Cancel
            </button>
            <button type="submit" class="btn btn-primary btn-full">
              <i class="fas fa-paper-plane"></i> Submit Application
            </button>
          </div>
        </form>
      </div>
    </div>

    <script>
      // Configuration
      const GEMINI_API_KEY = "AIzaSyCixpv02sanUBs4YqxX6p8CrMfeQeVToyg";
      const SUPABASE_URL = "https://ovvvwbtexnbxzacizokr.supabase.co";
      const SUPABASE_ANON_KEY =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im92dnZ3YnRleG5ieHphY2l6b2tyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM1ODQ5OTEsImV4cCI6MjA3OTE2MDk5MX0.Ii21cw1Iyops8Zo784P-25NKz2m-TCyJ2zWwI4V1kcE";

      console.log("üöÄ Initializing Supabase client...");
      const supabase = window.supabase.createClient(
        SUPABASE_URL,
        SUPABASE_ANON_KEY
      );

      // DOM elements
      const profileCriteria = document.getElementById("profileCriteria");
      const opportunitiesContainer = document.getElementById(
        "opportunitiesContainer"
      );
      const loading = document.getElementById("loading");
      const aiMatchingHeader = document.getElementById("aiMatchingHeader");
      const matchingStats = document.getElementById("matchingStats");
      const userName = document.getElementById("userName");
      const userAvatar = document.getElementById("user-avatar");
      const applicationModal = document.getElementById("applicationModal");
      const modalTitle = document.getElementById("modalTitle");
      const applicationInfo = document.getElementById("applicationInfo");
      const applicationForm = document.getElementById("applicationForm");
      const motivationText = document.getElementById("motivationText");
      const projectSummaryText = document.getElementById("projectSummaryText");
      const fileUploadArea = document.getElementById("fileUploadArea");
      const fileInput = document.getElementById("fileInput");
      const fileList = document.getElementById("fileList");

      // Global variables
      let currentUser = null;
      let currentProfile = null;
      let currentFundingOpportunity = null;
      let allFundingOpportunities = [];
      let uploadedFiles = [];
      let currentOpportunityForDetails = null;

      // Check authentication and load data
      document.addEventListener("DOMContentLoaded", async () => {
        console.log("üìÑ Page loaded, starting authentication check...");
        await checkAuth();
        await loadProfileAndOpportunities();

        // Initialize file upload drag and drop
        initializeFileUpload();
      });

      async function checkAuth() {
        console.log("üîê Checking authentication...");
        const userData = localStorage.getItem("fundfinder_user");

        if (!userData) {
          console.log("‚ùå No user data found, redirecting to login...");
          window.location.href = "login.html";
          return;
        }

        const user = JSON.parse(userData);
        currentUser = user;
        userName.textContent = user.email.split("@")[0];
        userAvatar.textContent = user.email.charAt(0).toUpperCase();
        console.log("‚úÖ User authenticated:", user.email);
      }

      // Update the loadProfileAndOpportunities function to include user email
      async function loadProfileAndOpportunities() {
        console.log("üìä Loading profile and opportunities...");
        const userData = JSON.parse(localStorage.getItem("fundfinder_user"));

        try {
          // Load SMME profile with criteria AND user email
          console.log("üë§ Loading SMME profile with criteria and user data...");
          const { data: profileData, error: profileError } = await supabase
            .from("smmes")
            .select(
              `
                *,
                users:user_id (
                    email
                )
            `
            )
            .eq("user_id", userData.id)
            .single();

          if (profileError || !profileData) {
            console.log(
              "‚ùå No profile found, redirecting to profile creation..."
            );
            window.location.href = "smme-profile.html";
            return;
          }

          console.log("‚úÖ Profile loaded:", profileData.business_name);

          // Combine profile data with user email
          currentProfile = {
            ...profileData,
            user_email: profileData.users?.email || userData.email,
          };

          displayProfileCriteria(currentProfile);

          // Rest of your existing code for loading opportunities...
          console.log("üí∞ Loading funding opportunities with criteria...");
          const { data: fundingOpportunities, error: fundingError } =
            await supabase.from("funding").select("*");

          if (fundingError) {
            console.error(
              "‚ùå Error loading funding opportunities:",
              fundingError
            );
            throw fundingError;
          }

          console.log(
            `‚úÖ Loaded ${fundingOpportunities.length} funding opportunities`
          );
          allFundingOpportunities = fundingOpportunities;

          // Use REAL AI for intelligent matching
          console.log("ü§ñ Starting REAL AI criteria matching...");
          const matchingResults = await matchWithRealAI(
            currentProfile,
            fundingOpportunities
          );

          console.log("‚úÖ REAL AI matching completed:", matchingResults);
          displayMatchingResults(matchingResults);
          displayOpportunities(matchingResults.matchedOpportunities);
        } catch (error) {
          console.error("‚ùå Error loading data:", error);
          opportunitiesContainer.innerHTML = `
            <div class="no-results">
                <h3>AI Matching Unavailable</h3>
                <p>Real AI matching is currently unavailable. Please try again later.</p>
                <button class="btn btn-primary" onclick="location.reload()">
                    <i class="fas fa-redo"></i> Retry AI Matching
                </button>
            </div>
        `;
        } finally {
          loading.style.display = "none";
          console.log("üèÅ Loading complete");
        }
      }

      function displayProfileCriteria(profile) {
        console.log("üìã Displaying profile criteria...");

        let criteriaHTML = "";

        if (profile.criteria) {
          criteriaHTML = `
        <div class="criteria-grid">
          ${
            profile.criteria.sector
              ? `
            <div class="criteria-item">
              <strong>Business Sector</strong>
              <span>${profile.criteria.sector}</span>
            </div>
          `
              : ""
          }
          
          ${
            profile.criteria.region
              ? `
            <div class="criteria-item">
              <strong>Operating Region</strong>
              <span>${profile.criteria.region}</span>
            </div>
          `
              : ""
          }
          
          ${
            profile.criteria.funding_amount_min
              ? `
            <div class="criteria-item">
              <strong>Funding Needed</strong>
              <span>R${profile.criteria.funding_amount_min.toLocaleString()} - R${
                  profile.criteria.funding_amount_max
                    ? profile.criteria.funding_amount_max.toLocaleString()
                    : "Open"
                }</span>
            </div>
          `
              : ""
          }
          
          ${
            profile.criteria.business_stage
              ? `
            <div class="criteria-item">
              <strong>Business Stage</strong>
              <span>${profile.criteria.business_stage}</span>
            </div>
          `
              : ""
          }

          ${
            profile.criteria.employees
              ? `
            <div class="criteria-item">
              <strong>Employees</strong>
              <span>${profile.criteria.employees}</span>
            </div>
          `
              : ""
          }

          ${
            profile.criteria.years_in_operation
              ? `
            <div class="criteria-item">
              <strong>Years in Operation</strong>
              <span>${profile.criteria.years_in_operation}</span>
            </div>
          `
              : ""
          }
        </div>
      `;
        } else {
          criteriaHTML = `
        <div class="criteria-grid">
          <div class="criteria-item">
            <strong>Business Sector</strong>
            <span>${profile.business_sector}</span>
          </div>
          <div class="criteria-item">
            <strong>Operating Region</strong>
            <span>${profile.region}</span>
          </div>
          <div class="criteria-item">
            <strong>Years in Operation</strong>
            <span>${profile.years_in_operation} years</span>
          </div>
          <div class="criteria-item">
            <strong>Business Stage</strong>
            <span>${
              profile.years_in_operation > 3 ? "Established" : "Growing"
            }</span>
          </div>
          ${
            profile.number_of_employees
              ? `
            <div class="criteria-item">
              <strong>Employees</strong>
              <span>${profile.number_of_employees}</span>
            </div>
          `
              : ""
          }
        </div>
      `;
        }

        profileCriteria.innerHTML = criteriaHTML;
      }

      async function matchWithRealAI(profile, opportunities) {
        console.log("üîç Starting REAL AI matching with 40% threshold...");

        const matchedOpportunities = [];

        // Clear loading and show initial message
        loading.innerHTML = `
        <div class="spinner"></div>
        <p>ü§ñ AI is analyzing ${opportunities.length} funding opportunities...</p>
        <p><small>Only showing opportunities with 40%+ match score</small></p>
    `;

        // Create a container for progressive results
        opportunitiesContainer.innerHTML = `
        <div id="progressContainer" style="text-align: center; padding: 2rem;">
            <h3>ü§ñ AI Matching in Progress</h3>
            <p>Analyzing opportunities with 40%+ match threshold...</p>
            <div id="progressStats" style="margin: 1rem 0;">
                <div style="display: inline-block; background: #e0e7ff; padding: 0.5rem 1rem; border-radius: 20px; margin: 0 0.5rem;">
                    <strong>0</strong> / ${opportunities.length}
                </div>
                <div style="display: inline-block; background: #f0f9ff; padding: 0.5rem 1rem; border-radius: 20px; margin: 0 0.5rem;">
                    <strong>0</strong> matches found
                </div>
            </div>
        </div>
        <div id="liveResults"></div>
    `;

        const progressContainer = document.getElementById("progressContainer");
        const progressStats = document.getElementById("progressStats");
        const liveResults = document.getElementById("liveResults");

        let processedCount = 0;
        let matchesFound = 0;

        for (const opportunity of opportunities) {
          if (!opportunity.criteria) {
            processedCount++;
            updateProgress(processedCount, opportunities.length, matchesFound);
            continue;
          }

          try {
            const aiMatchResult = await getRealAIMatchAnalysis(
              profile,
              opportunity
            );

            // CHANGED: Increased threshold from 20% to 40%
            if (aiMatchResult.matchScore >= 40) {
              const matchedOpportunity = {
                ...opportunity,
                ...aiMatchResult,
              };
              matchedOpportunities.push(matchedOpportunity);
              matchesFound++;

              // Immediately display this match
              displaySingleOpportunity(matchedOpportunity, liveResults);
            }

            processedCount++;
            updateProgress(processedCount, opportunities.length, matchesFound);
          } catch (error) {
            console.error(
              `‚ùå REAL AI matching failed for opportunity ${opportunity.id}:`,
              error
            );
            processedCount++;
            updateProgress(processedCount, opportunities.length, matchesFound);
            continue;
          }

          // Small delay to make progressive loading more visible (optional)
          await new Promise((resolve) => setTimeout(resolve, 100));
        }

        console.log(
          `‚úÖ REAL AI matching found ${matchedOpportunities.length} opportunities (40%+ threshold)`
        );

        // Final update when all processing is complete
        if (matchedOpportunities.length === 0) {
          progressContainer.innerHTML = `
            <div style="text-align: center; padding: 2rem;">
                <h3>ü§ñ No Strong Matches Found</h3>
                <p>No funding opportunities met the 40% match threshold with your business criteria.</p>
                <p><strong>Suggestions:</strong></p>
                <ul style="text-align: left; margin: 1rem 0; display: inline-block;">
                    <li>Update your business profile criteria</li>
                    <li>Consider broader sector options</li>
                    <li>Check back later for new opportunities</li>
                </ul>
                <div style="margin-top: 1rem;">
                    <a href="smme-profile.html" class="btn btn-primary">
                        <i class="fas fa-edit"></i> Update Criteria
                    </a>
                    <button class="btn btn-secondary" onclick="showAllOpportunities()" style="margin-left: 0.5rem;">
                        <i class="fas fa-eye"></i> Show All Opportunities
                    </button>
                </div>
            </div>
        `;
        } else {
          progressContainer.innerHTML = `
            <div style="text-align: center; padding: 1rem; background: #f0f9ff; border-radius: 8px; margin: 1rem 0;">
                <h4>‚úÖ AI Analysis Complete!</h4>
                <p>Found ${matchedOpportunities.length} opportunities with 40%+ match score</p>
                <button class="btn btn-outline" onclick="showAllOpportunities()" style="margin-top: 0.5rem;">
                    <i class="fas fa-eye"></i> Show All Opportunities
                </button>
            </div>
        `;
        }

        return {
          totalOpportunities: opportunities.length,
          matchedCount: matchedOpportunities.length,
          averageMatchScore:
            matchedOpportunities.length > 0
              ? matchedOpportunities.reduce(
                  (sum, opp) => sum + opp.matchScore,
                  0
                ) / matchedOpportunities.length
              : 0,
          matchedOpportunities: matchedOpportunities.sort(
            (a, b) => b.matchScore - a.matchScore
          ),
        };
      }

      function updateProgress(processed, total, matches) {
        const progressStats = document.getElementById("progressStats");
        if (progressStats) {
          progressStats.innerHTML = `
      <div style="display: inline-block; background: #e0e7ff; padding: 0.5rem 1rem; border-radius: 20px; margin: 0 0.5rem;">
        <strong>${processed}</strong> / ${total} processed
      </div>
      <div style="display: inline-block; background: #f0f9ff; padding: 0.5rem 1rem; border-radius: 20px; margin: 0 0.5rem;">
        <strong>${matches}</strong> matches found
      </div>
    `;
        }
      }

      function displaySingleOpportunity(opportunity, container) {
        const matchLevel = getMatchLevel(opportunity.matchScore);
        const fundingBadge = getFundingTypeBadge(opportunity);
        const fundingIcon = getFundingTypeIcon(opportunity);

        const opportunityElement = document.createElement("div");
        opportunityElement.innerHTML = `
    <div class="opportunity-card ${
      matchLevel.level
    }-match" style="animation: fadeIn 0.5s ease-in;">
      ${
        fundingBadge
          ? `
        <div class="opportunity-badge ${fundingBadge.class}">
          ${fundingBadge.label}
        </div>
      `
          : ""
      }
      
      <div class="opportunity-header">
        <div class="opportunity-title">
          <h3><i class="${fundingIcon}"></i> ${opportunity.name}</h3>
          <p>${opportunity.description || "No description available"}</p>
          <div class="funding-type-indicator">
            <i class="fas fa-tag"></i>
            ${getFundingTypeDescription(opportunity)}
          </div>
        </div>
        <div class="match-badge ${matchLevel.level}">
          ${opportunity.matchScore}% AI Match
        </div>
      </div>

      <div class="opportunity-details">
        ${
          opportunity.criteria?.funding_amount_min
            ? `
          <div class="detail-item">
            <strong>Funding Range</strong>
            <span>R${opportunity.criteria.funding_amount_min.toLocaleString()} - R${
                opportunity.criteria.funding_amount_max
                  ? opportunity.criteria.funding_amount_max.toLocaleString()
                  : "Open"
              }</span>
          </div>
        `
            : ""
        }
        
        ${
          opportunity.criteria?.sector
            ? `
          <div class="detail-item">
            <strong>Sector Focus</strong>
            <span>${
              opportunity.criteria.sector.charAt(0).toUpperCase() +
              opportunity.criteria.sector.slice(1)
            }</span>
          </div>
        `
            : ""
        }
        
        ${
          opportunity.criteria?.region
            ? `
          <div class="detail-item">
            <strong>Region Focus</strong>
            <span>${
              opportunity.criteria.region.charAt(0).toUpperCase() +
              opportunity.criteria.region.slice(1)
            }</span>
          </div>
        `
            : ""
        }
        
        ${
          opportunity.criteria?.business_stage
            ? `
          <div class="detail-item">
            <strong>Business Stage</strong>
            <span>${
              opportunity.criteria.business_stage.charAt(0).toUpperCase() +
              opportunity.criteria.business_stage.slice(1)
            }</span>
          </div>
        `
            : ""
        }
      </div>

      <div class="match-analysis">
        <h4><i class="fas fa-robot"></i> REAL AI Analysis</h4>
        <div class="match-reasons">${opportunity.matchReasoning}</div>
      </div>

      <div class="ai-suggestions">
        <h4><i class="fas fa-lightbulb"></i> AI Application Strategy</h4>
        <ul>
          ${opportunity.aiSuggestions
            .map(
              (suggestion) =>
                `<li><i class="fas fa-check"></i> ${suggestion}</li>`
            )
            .join("")}
        </ul>
      </div>

      <div class="opportunity-actions">
        <button class="btn btn-secondary" onclick="viewDetails('${
          opportunity.id
        }')">
          <i class="fas fa-info-circle"></i> View Details
        </button>
        <button class="btn btn-primary" onclick="applyForFunding('${
          opportunity.id
        }')">
          <i class="fas fa-paper-plane"></i> Apply Now
        </button>
      </div>
    </div>
  `;

        // Add fade-in animation
        container.appendChild(opportunityElement);
      }

      async function getRealAIMatchAnalysis(profile, opportunity) {
        console.log(`ü§ñ REAL AI analyzing match for: ${opportunity.name}`);

        const prompt = `
CRITICAL: You MUST respond with ONLY valid JSON. No other text.

Analyze the compatibility between this business and funding opportunity. Provide a JSON response with:
- matchScore (0-100)
- matchReasoning (string explaining key compatibility factors)
- aiSuggestions (array of 3 application tips)

BUSINESS PROFILE:
- Name: ${profile.business_name}
- Sector: ${profile.business_sector}
- Region: ${profile.region}
- Years in Operation: ${profile.years_in_operation}
- Employees: ${profile.number_of_employees}
- Business Stage: ${profile.criteria?.business_stage || "Not specified"}
- Funding Need: R${
          profile.criteria?.funding_amount_min || "Not specified"
        } - R${profile.criteria?.funding_amount_max || "Open"}
- Project: ${profile.project_description}

FUNDING OPPORTUNITY:
- Name: ${opportunity.name}
- Description: ${opportunity.description}
- Sector Focus: ${opportunity.criteria?.sector || "Any"}
- Region Focus: ${opportunity.criteria?.region || "National"}
- Business Stage: ${opportunity.criteria?.business_stage || "Any"}
- Funding Range: ${opportunity.criteria?.amount_range || "Not specified"}
- Requirements: ${opportunity.criteria?.requirements || "None"}

Consider sector alignment, regional fit, business stage compatibility, funding amount appropriateness, and overall strategic fit. Be realistic but encouraging.

RESPONSE FORMAT (JSON ONLY):
{
  "matchScore": 85,
  "matchReasoning": "Strong sector alignment and regional fit...",
  "aiSuggestions": ["Tip 1", "Tip 2", "Tip 3"]
}
`;

        try {
          // Using the latest Gemini 2.0 Flash model with correct API structure
          const response = await fetch(
            `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}`,
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                contents: [
                  {
                    parts: [
                      {
                        text: prompt,
                      },
                    ],
                  },
                ],
                generationConfig: {
                  temperature: 0.3,
                  maxOutputTokens: 800,
                },
              }),
            }
          );

          if (!response.ok) {
            const errorText = await response.text();
            console.error("‚ùå AI API Error Response:", errorText);
            throw new Error(
              `AI API request failed: ${response.status} - ${errorText}`
            );
          }

          const data = await response.json();

          if (
            !data.candidates ||
            !data.candidates[0] ||
            !data.candidates[0].content
          ) {
            console.error("‚ùå Invalid AI response structure:", data);
            throw new Error("Invalid AI response structure");
          }

          const aiResponse = data.candidates[0].content.parts[0].text;
          console.log("ü§ñ Raw AI Response:", aiResponse);

          // Clean the response and extract JSON
          const cleanedResponse = aiResponse
            .replace(/```json\s*|\s*```/g, "")
            .trim();
          const jsonMatch = cleanedResponse.match(/\{[\s\S]*\}/);

          if (!jsonMatch) {
            console.error("‚ùå No JSON found in AI response:", cleanedResponse);
            throw new Error("No valid JSON in AI response");
          }

          const result = JSON.parse(jsonMatch[0]);

          // Validate required fields
          if (
            typeof result.matchScore !== "number" ||
            typeof result.matchReasoning !== "string" ||
            !Array.isArray(result.aiSuggestions)
          ) {
            throw new Error(
              "Invalid AI response format - missing required fields"
            );
          }

          console.log(`‚úÖ REAL AI match score: ${result.matchScore}%`);
          return result;
        } catch (error) {
          console.error("‚ùå REAL AI API Error:", error);
          throw error; // Re-throw to skip this opportunity
        }
      }
      function getFundingTypeBadge(opportunity) {
        const criteria = opportunity.criteria || {};

        // Special programs first (highest priority)
        if (criteria.owner_gender === "female") {
          return { type: "special", label: "Women-Focused", class: "special" };
        }
        if (criteria.owner_age_max === 35) {
          return { type: "special", label: "Youth Program", class: "special" };
        }

        // Sector-specific next (medium priority)
        if (
          criteria.sector &&
          criteria.sector !== "any" &&
          criteria.sector !== "all"
        ) {
          const sectorLabels = {
            technology: "Tech Fund",
            agriculture: "Agriculture Fund",
            manufacturing: "Manufacturing Fund",
            "retail & e-commerce": "Retail Fund",
            "tourism & hospitality": "Tourism Fund",
            "professional services": "Services Fund",
            construction: "Construction Fund",
            education: "Education Fund",
            healthcare: "Healthcare Fund",
            "renewable-energy": "Energy Fund",
          };
          return {
            type: "sector",
            label: sectorLabels[criteria.sector] || "Sector Fund",
            class: "sector",
          };
        }

        // Regional last (lowest priority)
        if (
          criteria.region &&
          criteria.region !== "national" &&
          criteria.region !== "all"
        ) {
          return {
            type: "regional",
            label: `${criteria.region} Fund`,
            class: "regional",
          };
        }

        return null;
      }

      function getFundingTypeIcon(opportunity) {
        const criteria = opportunity.criteria || {};
        const name = opportunity.name.toLowerCase();
        const sector = criteria.sector ? criteria.sector.toLowerCase() : "";

        // First check specific criteria
        if (criteria.owner_gender === "female") return "fas fa-female";
        if (criteria.owner_age_max === 35) return "fas fa-user-graduate";

        // Then check sector from criteria
        if (
          sector.includes("tech") ||
          sector.includes("innovation") ||
          name.includes("tech") ||
          name.includes("innovation")
        )
          return "fas fa-laptop-code";
        if (
          sector.includes("agriculture") ||
          sector.includes("farming") ||
          name.includes("agriculture") ||
          name.includes("farming")
        )
          return "fas fa-tractor";
        if (sector.includes("manufacturing") || name.includes("manufacturing"))
          return "fas fa-industry";
        if (
          sector.includes("retail") ||
          sector.includes("ecommerce") ||
          sector.includes("e-commerce") ||
          name.includes("retail") ||
          name.includes("ecommerce")
        )
          return "fas fa-shopping-cart";
        if (
          sector.includes("tourism") ||
          sector.includes("hospitality") ||
          name.includes("tourism") ||
          name.includes("hospitality")
        )
          return "fas fa-hotel";
        if (
          sector.includes("professional") ||
          sector.includes("services") ||
          name.includes("consulting") ||
          name.includes("professional")
        )
          return "fas fa-briefcase";
        if (
          sector.includes("construction") ||
          name.includes("construction") ||
          name.includes("infrastructure")
        )
          return "fas fa-hard-hat";
        if (
          sector.includes("education") ||
          name.includes("education") ||
          name.includes("edtech")
        )
          return "fas fa-graduation-cap";
        if (
          sector.includes("health") ||
          sector.includes("medical") ||
          name.includes("health") ||
          name.includes("medical")
        )
          return "fas fa-heartbeat";
        if (
          sector.includes("energy") ||
          sector.includes("green") ||
          sector.includes("renewable") ||
          name.includes("energy") ||
          name.includes("green")
        )
          return "fas fa-bolt";

        // Default icon
        return "fas fa-hand-holding-usd";
      }

      function getFundingTypeDescription(opportunity) {
        const criteria = opportunity.criteria || {};

        if (criteria.owner_gender === "female")
          return "Women Entrepreneurship Support";
        if (criteria.owner_age_max === 35) return "Youth Development Program";
        if (criteria.region && criteria.region !== "national")
          return `${
            criteria.region.charAt(0).toUpperCase() + criteria.region.slice(1)
          } Regional Fund`;
        if (criteria.sector && criteria.sector !== "any") {
          const sectorMap = {
            technology: "Technology Innovation",
            agriculture: "Agricultural Development",
            manufacturing: "Manufacturing Growth",
            "retail & e-commerce": "Retail & E-commerce",
            "tourism & hospitality": "Tourism & Hospitality",
            "professional services": "Professional Services",
            construction: "Construction & Infrastructure",
            education: "Education Innovation",
            healthcare: "Healthcare Development",
            "renewable-energy": "Renewable Energy",
          };
          return (
            sectorMap[criteria.sector] ||
            `${
              criteria.sector.charAt(0).toUpperCase() + criteria.sector.slice(1)
            } Sector Focus`
          );
        }

        return "General Business Funding";
      }

      function displayMatchingResults(results) {
        console.log("üìä Displaying matching results...");
        aiMatchingHeader.style.display = "block";

        matchingStats.innerHTML = `
      <div class="stat-item">
        <div class="stat-value">${results.totalOpportunities}</div>
        <div class="stat-label">Total Opportunities</div>
      </div>
      <div class="stat-item">
        <div class="stat-value">${results.matchedCount}</div>
        <div class="stat-label">AI Matches Found</div>
      </div>
      <div class="stat-item">
        <div class="stat-value">${Math.round(results.averageMatchScore)}%</div>
        <div class="stat-label">Avg AI Match Score</div>
      </div>
      <div class="stat-item">
        <div class="stat-value">${Math.round(
          (results.matchedCount / results.totalOpportunities) * 100
        )}%</div>
        <div class="stat-label">AI Match Rate</div>
      </div>
    `;
      }

      function displayOpportunities(opportunities) {
        console.log(
          "üéØ Displaying REAL AI matched opportunities:",
          opportunities.length
        );

        if (opportunities.length === 0) {
          console.log("‚ùå No REAL AI matches found");
          opportunitiesContainer.innerHTML = `
        <div class="no-results">
          <h3>ü§ñ No AI Matches Found</h3>
          <p>Our real AI analysis couldn't find strong matches for your business criteria. This could be because:</p>
          <ul style="text-align: left; margin: 1rem 0;">
            <li>Your business criteria are very specific</li>
            <li>Current funding opportunities don't align with your profile</li>
            <li>Try updating your business profile with broader criteria</li>
          </ul>
          <div style="display: flex; gap: 1rem; justify-content: center; margin-top: 1.5rem;">
            <a href="smme-profile.html" class="btn btn-primary">
              <i class="fas fa-edit"></i> Update Business Criteria
            </a>
            <button class="btn btn-secondary" onclick="location.reload()">
              <i class="fas fa-robot"></i> Retry AI Analysis
            </button>
          </div>
        </div>
      `;
          return;
        }

        opportunitiesContainer.innerHTML = opportunities
          .map((opp) => {
            const matchLevel = getMatchLevel(opp.matchScore);
            const fundingBadge = getFundingTypeBadge(opp);
            const fundingIcon = getFundingTypeIcon(opp);

            return `
        <div class="opportunity-card ${matchLevel.level}-match">
          ${
            fundingBadge
              ? `
            <div class="opportunity-badge ${fundingBadge.class}">
              ${fundingBadge.label}
            </div>
          `
              : ""
          }
          
          <div class="opportunity-header">
            <div class="opportunity-title">
              <h3><i class="${fundingIcon}"></i> ${opp.name}</h3>
              <p>${opp.description || "No description available"}</p>
              <div class="funding-type-indicator">
                <i class="fas fa-tag"></i>
                ${getFundingTypeDescription(opp)}
              </div>
            </div>
            <div class="match-badge ${matchLevel.level}">
              ${opp.matchScore}% AI Match
            </div>
          </div>

          <div class="opportunity-details">
            ${
              opp.criteria?.funding_amount_min
                ? `
              <div class="detail-item">
                <strong>Funding Range</strong>
                <span>R${opp.criteria.funding_amount_min.toLocaleString()} - R${
                    opp.criteria.funding_amount_max
                      ? opp.criteria.funding_amount_max.toLocaleString()
                      : "Open"
                  }</span>
              </div>
            `
                : ""
            }
            
            ${
              opp.criteria?.sector
                ? `
              <div class="detail-item">
                <strong>Sector Focus</strong>
                <span>${
                  opp.criteria.sector.charAt(0).toUpperCase() +
                  opp.criteria.sector.slice(1)
                }</span>
              </div>
            `
                : ""
            }
            
            ${
              opp.criteria?.region
                ? `
              <div class="detail-item">
                <strong>Region Focus</strong>
                <span>${
                  opp.criteria.region.charAt(0).toUpperCase() +
                  opp.criteria.region.slice(1)
                }</span>
              </div>
            `
                : ""
            }
            
            ${
              opp.criteria?.business_stage
                ? `
              <div class="detail-item">
                <strong>Business Stage</strong>
                <span>${
                  opp.criteria.business_stage.charAt(0).toUpperCase() +
                  opp.criteria.business_stage.slice(1)
                }</span>
              </div>
            `
                : ""
            }
          </div>

          <div class="match-analysis">
            <h4><i class="fas fa-robot"></i> REAL AI Analysis</h4>
            <div class="match-reasons">${opp.matchReasoning}</div>
          </div>

          <div class="ai-suggestions">
            <h4><i class="fas fa-lightbulb"></i> AI Application Strategy</h4>
            <ul>
              ${opp.aiSuggestions
                .map(
                  (suggestion) =>
                    `<li><i class="fas fa-check"></i> ${suggestion}</li>`
                )
                .join("")}
            </ul>
          </div>

          <div class="opportunity-actions">
            <button class="btn btn-secondary" onclick="viewDetails('${
              opp.id
            }')">
              <i class="fas fa-info-circle"></i> View Details
            </button>
            <button class="btn btn-primary" onclick="applyForFunding('${
              opp.id
            }')">
              <i class="fas fa-paper-plane"></i> Apply Now
            </button>
          </div>
        </div>
      `;
          })
          .join("");
      }

      function getFundingTypeDescription(opportunity) {
        const criteria = opportunity.criteria || {};

        if (criteria.owner_gender === "female")
          return "Women Entrepreneurship Support";
        if (criteria.owner_age_max === 35) return "Youth Development Program";
        if (criteria.region && criteria.region !== "national")
          return `${
            criteria.region.charAt(0).toUpperCase() + criteria.region.slice(1)
          } Regional Fund`;
        if (criteria.sector && criteria.sector !== "any")
          return `${
            criteria.sector.charAt(0).toUpperCase() + criteria.sector.slice(1)
          } Sector Focus`;

        return "General Business Funding";
      }

      function getMatchLevel(score) {
        if (score >= 75) return { level: "high", label: "Perfect AI Match" };
        if (score >= 50) return { level: "medium", label: "Strong AI Match" };
        return { level: "low", label: "Good AI Match" };
      }

      // Replace the existing viewDetails function
      function viewDetails(opportunityId) {
        console.log("üîç Viewing details for:", opportunityId);
        const opportunity = allFundingOpportunities.find(
          (opp) => opp.id === opportunityId
        );

        if (!opportunity) {
          alert("Funding opportunity not found");
          return;
        }

        currentOpportunityForDetails = opportunity;
        showDetailsModal(opportunity);
      }

      function showDetailsModal(opportunity) {
        const criteria = opportunity.criteria || {};
        const detailsModal = document.getElementById("detailsModal");
        const detailsModalTitle = document.getElementById("detailsModalTitle");
        const detailsModalBody = document.getElementById("detailsModalBody");
        const applyFromDetailsBtn = document.getElementById(
          "applyFromDetailsBtn"
        );

        detailsModalTitle.textContent = opportunity.name;

        // Build detailed modal content
        detailsModalBody.innerHTML = `
        <div class="details-section">
            <h3><i class="fas fa-info-circle"></i> Opportunity Overview</h3>
            <p style="color: var(--color-gray); line-height: 1.6; margin-bottom: 1.5rem;">${
              opportunity.description || "No description available."
            }</p>
            
            <div class="detail-grid">
                <div class="detail-item">
                    <span class="detail-label">Funding Amount Range</span>
                    <span class="detail-value">${
                      criteria.amount_range || "Not specified"
                    }</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Sector Focus</span>
                    <span class="detail-value">${
                      criteria.sector
                        ? criteria.sector.charAt(0).toUpperCase() +
                          criteria.sector.slice(1)
                        : "Any Sector"
                    }</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Region Focus</span>
                    <span class="detail-value">${
                      criteria.region
                        ? criteria.region.charAt(0).toUpperCase() +
                          criteria.region.slice(1)
                        : "National"
                    }</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Business Stage</span>
                    <span class="detail-value">${
                      criteria.business_stage
                        ? criteria.business_stage.charAt(0).toUpperCase() +
                          criteria.business_stage.slice(1)
                        : "Any Stage"
                    }</span>
                </div>
            </div>
        </div>

        <div class="details-section">
            <h3><i class="fas fa-list-check"></i> Requirements</h3>
            <ul class="requirements-list">
                ${(criteria.requirements
                  ? criteria.requirements.split(", ")
                  : ["No specific requirements listed"]
                )
                  .map(
                    (req) =>
                      `<li><i class="fas fa-check"></i> ${req.trim()}</li>`
                  )
                  .join("")}
            </ul>
        </div>

        ${
          criteria.deadline
            ? `
        <div class="details-section">
            <h3><i class="fas fa-calendar-alt"></i> Timeline</h3>
            <div class="detail-item">
                <span class="detail-label">Application Deadline</span>
                <span class="detail-value">${new Date(
                  criteria.deadline
                ).toLocaleDateString("en-ZA", {
                  year: "numeric",
                  month: "long",
                  day: "numeric",
                })}</span>
            </div>
        </div>
        `
            : ""
        }

        <div class="details-section">
            <h3><i class="fas fa-lightbulb"></i> Key Benefits</h3>
            <div class="match-highlights">
                <h4>Why this opportunity matches your business:</h4>
                <p>${
                  opportunity.matchReasoning ||
                  "Good overall fit based on your business criteria and profile."
                }</p>
            </div>
        </div>
    `;

        // Set up the apply button
        applyFromDetailsBtn.onclick = () => {
          closeDetailsModal();
          applyForFunding(opportunity.id);
        };

        detailsModal.classList.add("active");
      }

      function closeDetailsModal() {
        const detailsModal = document.getElementById("detailsModal");
        detailsModal.classList.remove("active");
        currentOpportunityForDetails = null;
      }
      // Initialize file upload with drag and drop
      function initializeFileUpload() {
        fileUploadArea.addEventListener("dragover", (e) => {
          e.preventDefault();
          fileUploadArea.classList.add("dragover");
        });

        fileUploadArea.addEventListener("dragleave", (e) => {
          e.preventDefault();
          fileUploadArea.classList.remove("dragover");
        });

        fileUploadArea.addEventListener("drop", (e) => {
          e.preventDefault();
          fileUploadArea.classList.remove("dragover");
          const files = e.dataTransfer.files;
          handleFiles(files);
        });
      }

      function handleFileSelect(event) {
        const files = event.target.files;
        handleFiles(files);
      }

      function handleFiles(files) {
        const maxFiles = 5;
        const maxSize = 10 * 1024 * 1024;

        if (uploadedFiles.length + files.length > maxFiles) {
          alert(`You can only upload up to ${maxFiles} files.`);
          return;
        }

        for (let file of files) {
          if (file.type !== "application/pdf") {
            alert(
              `"${file.name}" is not a PDF file. Please upload PDF files only.`
            );
            continue;
          }

          if (file.size > maxSize) {
            alert(`"${file.name}" is too large. Maximum file size is 10MB.`);
            continue;
          }

          uploadedFiles.push(file);
          addFileToList(file);
        }

        fileInput.value = "";
      }

      function addFileToList(file) {
        const fileItem = document.createElement("div");
        fileItem.className = "file-item";

        const fileSize = (file.size / (1024 * 1024)).toFixed(2) + " MB";

        fileItem.innerHTML = `
      <div class="file-info">
        <i class="fas fa-file-pdf file-icon"></i>
        <div>
          <div class="file-name">${file.name}</div>
          <div class="file-size">${fileSize}</div>
        </div>
      </div>
      <button type="button" class="file-remove" onclick="removeFile('${file.name}')">
        <i class="fas fa-times"></i>
      </button>
    `;

        fileList.appendChild(fileItem);
      }

      function removeFile(fileName) {
        uploadedFiles = uploadedFiles.filter((file) => file.name !== fileName);
        fileList.innerHTML = "";
        uploadedFiles.forEach((file) => addFileToList(file));
      }

      async function generateProjectSummary(opportunity) {
        projectSummaryText.innerHTML = `
  <div class="loading">
    <div class="spinner" style="width: 20px; height: 20px;"></div>
    <p>AI is generating your project summary...</p>
  </div>
`;

        try {
          const prompt = `
Create a concise 150-200 word project summary for a funding application with these details:

BUSINESS: ${currentProfile.business_name} - ${
            currentProfile.business_sector
          } in ${currentProfile.region}
EXPERIENCE: ${currentProfile.years_in_operation} years in business, ${
            currentProfile.number_of_employees || "several"
          } employees
PROJECT: ${currentProfile.project_description}
FUNDING USE: ${currentProfile.fund_usage}
OPPORTUNITY: ${opportunity.name} - ${opportunity.description}

Write a professional project summary that:
1. Clearly states the project objectives
2. Highlights the expected outcomes and impact
3. Shows alignment with the funding opportunity
4. Demonstrates business capability
5. Is concise and compelling

Focus on clarity, impact, and alignment with the funding criteria.
      `;

          // Using the latest Gemini 2.0 Flash model
          const response = await fetch(
            `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}`,
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                contents: [
                  {
                    parts: [
                      {
                        text: prompt,
                      },
                    ],
                  },
                ],
              }),
            }
          );

          if (response.ok) {
            const data = await response.json();
            const summary = data.candidates[0].content.parts[0].text;
            projectSummaryText.value = summary;
          } else {
            throw new Error("AI API failed");
          }
        } catch (error) {
          console.error("Error generating project summary:", error);
          projectSummaryText.textContent =
            "AI content generation failed. Please write your project summary manually.";
        }
      }

      async function generateMotivationLetter(opportunity) {
        motivationText.value = "AI is generating your motivation letter...";

        try {
          const prompt = `
Create a professional funding application motivation letter with these specific details:

APPLICANT INFORMATION:
- Business Name: ${currentProfile.business_name}
- Contact Person: ${currentProfile.owner_name || "The Management Team"}
- Email: ${currentProfile.user_email}
- Business Sector: ${currentProfile.business_sector}
- Location: ${currentProfile.region}
- Years in Operation: ${currentProfile.years_in_operation}
- Team Size: ${
            currentProfile.number_of_employees ||
            "growing team of professionals"
          }
- Registration: ${currentProfile.registration_number || "Registered business"}

BUSINESS BACKGROUND:
- Experience: ${currentProfile.years_in_operation} years in business
- Sector Expertise: ${currentProfile.business_sector}
- Regional Presence: ${currentProfile.region}
- Business Description: ${currentProfile.business_description}

PROJECT DETAILS:
- Project Description: ${currentProfile.project_description}
- Funding Purpose: ${currentProfile.fund_usage}
- Expected Impact: Job creation, economic growth, community development

FUNDING OPPORTUNITY:
- Opportunity Name: ${opportunity.name}
- Description: ${opportunity.description}
- Focus Areas: ${opportunity.criteria?.sector || "Various sectors"}
- Regional Focus: ${opportunity.criteria?.region || "National"}

Write a compelling 250-300 word motivation letter that:
1. Formally introduces ${currentProfile.business_name} and ${
            currentProfile.owner_name || "our management team"
          }
2. Highlights our ${currentProfile.years_in_operation} years of experience in ${
            currentProfile.business_sector
          }
3. Explains how our project aligns with ${opportunity.name}'s objectives
4. Demonstrates our capability to successfully execute the project
5. Shows the positive impact on the ${currentProfile.region} community
6. Includes our contact information: ${currentProfile.user_email}

Use a professional, confident tone and ensure the letter is personalized with our specific business details. Focus on creating sustainable impact and long-term value.

Format as a formal business letter with appropriate salutation and closing.
        `;

          const response = await fetch(
            `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}`,
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                contents: [
                  {
                    parts: [
                      {
                        text: prompt,
                      },
                    ],
                  },
                ],
                generationConfig: {
                  temperature: 0.7,
                  maxOutputTokens: 1024,
                },
              }),
            }
          );

          if (response.ok) {
            const data = await response.json();
            const letter = data.candidates[0].content.parts[0].text;
            motivationText.value = letter;
          } else {
            throw new Error("AI API failed");
          }
        } catch (error) {
          console.error("Error generating motivation letter:", error);
          motivationText.textContent =
            "AI content generation failed. Please write your motivation letter manually.";
        }
      }

      async function regenerateProjectSummary() {
        if (currentFundingOpportunity) {
          await generateProjectSummary(currentFundingOpportunity);
        }
      }

      async function regenerateMotivation() {
        if (currentFundingOpportunity) {
          await generateMotivationLetter(currentFundingOpportunity);
        }
      }

      async function applyForFunding(opportunityId) {
        console.log("üìù Applying for funding:", opportunityId);

        const opportunity = allFundingOpportunities.find(
          (opp) => opp.id === opportunityId
        );
        if (!opportunity) {
          alert("Funding opportunity not found");
          return;
        }

        currentFundingOpportunity = opportunity;

        const { data: funder } = await supabase
          .from("users")
          .select("email")
          .eq("id", opportunity.funder_id)
          .single();

        modalTitle.textContent = `Apply for: ${opportunity.name}`;
        applicationInfo.innerHTML = `
      <h3>${opportunity.name}</h3>
      <p><strong>Funder:</strong> ${funder?.email || "Unknown"}</p>
      <p><strong>Description:</strong> ${
        opportunity.description || "No description available"
      }</p>
      ${
        opportunity.criteria?.amount_range
          ? `<p><strong>Funding Range:</strong> ${opportunity.criteria.amount_range}</p>`
          : ""
      }
    `;

        applicationForm.reset();
        uploadedFiles = [];
        fileList.innerHTML = "";

        await generateProjectSummary(opportunity);
        await generateMotivationLetter(opportunity);

        applicationModal.classList.add("active");
      }

      function closeApplicationModal() {
        applicationModal.classList.remove("active");
        currentFundingOpportunity = null;
        uploadedFiles = [];
        fileList.innerHTML = "";
      }
      applicationForm.addEventListener("submit", async (e) => {
        e.preventDefault();

        if (!currentFundingOpportunity) {
          alert("No funding opportunity selected");
          return;
        }

        const formData = new FormData(applicationForm);
        const applicationData = {
          requestedAmount: formData.get("requestedAmount"),
          projectSummary: projectSummaryText.value,
          motivationLetter: motivationText.value,
          termsAccepted: formData.get("termsAccepted") === "on",
          uploadedFiles: uploadedFiles.map((file) => ({
            name: file.name,
            size: file.size,
            type: file.type,
          })),
        };

        if (
          !applicationData.requestedAmount ||
          !applicationData.termsAccepted
        ) {
          alert(
            "Please fill in all required fields and accept the terms and conditions"
          );
          return;
        }

        try {
          const applicationRecord = {
            smme_id: currentUser.id,
            funder_id: currentFundingOpportunity.funder_id,
            funding_id: currentFundingOpportunity.id,
            form_data: {
              requestedAmount: applicationData.requestedAmount,
              projectSummary: applicationData.projectSummary,
              motivationLetter: applicationData.motivationLetter,
              uploadedDocuments: applicationData.uploadedFiles,
              // Enhanced SMME information
              businessName: currentProfile.business_name,
              ownerName: currentProfile.owner_name,
              businessEmail: currentProfile.user_email,
              businessSector: currentProfile.business_sector,
              region: currentProfile.region,
              yearsInOperation: currentProfile.years_in_operation,
              employeeCount: currentProfile.number_of_employees,
              registrationNumber: currentProfile.registration_number,
              submittedAt: new Date().toISOString(),
            },
            status: "Submitted",
          };

          const { data, error } = await supabase
            .from("applications")
            .insert([applicationRecord])
            .select();

          if (error) throw error;

          alert(
            "üéâ Application submitted successfully!\n\nYour application has been sent to the funder for review. You can track its progress in the 'My Applications' section."
          );

          closeApplicationModal();
          setTimeout(() => {
            window.location.href = "smme-applications.html";
          }, 2000);
        } catch (error) {
          console.error("Error submitting application:", error);
          alert("Error submitting application. Please try again.");
        }
      });

      function logout() {
        console.log("üö™ Logging out...");
        localStorage.removeItem("fundfinder_user");
        window.location.href = "login.html";
      }

      window.onclick = function (event) {
        if (event.target === applicationModal) {
          closeApplicationModal();
        }
      };

      // Make functions globally available
      window.viewDetails = viewDetails;
      window.applyForFunding = applyForFunding;
      window.regenerateProjectSummary = regenerateProjectSummary;
      window.regenerateMotivation = regenerateMotivation;
      window.removeFile = removeFile;
      window.handleFileSelect = handleFileSelect;
      window.closeApplicationModal = closeApplicationModal;
      window.logout = logout;
    </script>
  </body>
</html>
