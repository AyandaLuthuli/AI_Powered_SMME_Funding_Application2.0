<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>FundFinder - AI-Powered Funding Opportunities</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Inter", sans-serif;
        line-height: 1.6;
        color: #333;
        background: #f5f7fa;
      }

      /* Header */
      .header {
        background: #fff;
        padding: 1rem 2rem;
        border-bottom: 1px solid #e0e0e0;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      .logo {
        font-weight: 700;
        font-size: 1.8rem;
        color: #2d2dff;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .nav-links {
        display: flex;
        gap: 2rem;
        align-items: center;
      }

      .nav-links a {
        color: #333;
        text-decoration: none;
        font-weight: 500;
        padding: 0.5rem 1rem;
        border-radius: 8px;
        transition: all 0.3s;
      }

      .nav-links a:hover,
      .nav-links a.active {
        background: #2d2dff;
        color: white;
      }

      .user-menu {
        display: flex;
        align-items: center;
        gap: 1rem;
      }

      .user-info {
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .user-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: linear-gradient(135deg, #2d2dff, #667eea);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 600;
      }

      .logout-btn {
        background: #ff4757;
        color: white;
        border: none;
        padding: 0.6rem 1.2rem;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s;
      }

      .logout-btn:hover {
        background: #ff3742;
        transform: translateY(-2px);
      }

      /* Main Content */
      .main-content {
        max-width: 1200px;
        margin: 0 auto;
        padding: 2rem;
      }

      .page-header {
        text-align: center;
        margin-bottom: 3rem;
      }

      .page-header h1 {
        color: #2d2dff;
        font-size: 2.5rem;
        margin-bottom: 0.5rem;
      }

      .page-header p {
        color: #666;
        font-size: 1.2rem;
      }

      /* Profile Summary */
      .profile-summary {
        background: #fff;
        padding: 2rem;
        border-radius: 12px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        margin-bottom: 2rem;
      }

      .profile-summary h2 {
        color: #2d2dff;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .criteria-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-top: 1rem;
      }

      .criteria-item {
        padding: 1rem;
        background: #f8f9fa;
        border-radius: 8px;
        border-left: 4px solid #2d2dff;
      }

      .criteria-item strong {
        color: #333;
        display: block;
        margin-bottom: 0.25rem;
        font-size: 0.9rem;
      }

      .profile-actions {
        margin-top: 1.5rem;
        text-align: right;
      }

      /* AI Matching Section */
      .ai-matching-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 2rem;
        border-radius: 12px;
        margin-bottom: 2rem;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        text-align: center;
      }

      .ai-matching-header h2 {
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
      }

      .matching-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 1rem;
        margin-top: 1.5rem;
      }

      .stat-item {
        background: rgba(255, 255, 255, 0.1);
        padding: 1rem;
        border-radius: 8px;
        text-align: center;
      }

      .stat-value {
        font-size: 1.5rem;
        font-weight: 700;
        margin-bottom: 0.25rem;
      }

      .stat-label {
        font-size: 0.9rem;
        opacity: 0.9;
      }

      /* Funding Opportunities */
      .opportunities-container {
        display: grid;
        gap: 1.5rem;
      }

      .opportunity-card {
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        padding: 2rem;
        transition: transform 0.3s, box-shadow 0.3s;
        border: 2px solid transparent;
        position: relative;
      }

      .opportunity-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
      }

      .opportunity-card.high-match {
        border-color: #10b981;
      }

      .opportunity-card.medium-match {
        border-color: #f59e0b;
      }

      .opportunity-card.low-match {
        border-color: #ef4444;
      }

      .opportunity-badge {
        position: absolute;
        top: -10px;
        right: 20px;
        background: #2d2dff;
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 15px;
        font-size: 0.8rem;
        font-weight: 600;
      }

      .opportunity-badge.special {
        background: #8b5cf6;
      }

      .opportunity-badge.regional {
        background: #06b6d4;
      }

      .opportunity-badge.sector {
        background: #10b981;
      }

      .opportunity-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 1.5rem;
      }

      .opportunity-title {
        flex: 1;
      }

      .opportunity-title h3 {
        color: #2d2dff;
        margin-bottom: 0.5rem;
        font-size: 1.4rem;
      }

      .match-badge {
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-weight: 600;
        font-size: 0.9rem;
        white-space: nowrap;
      }

      .match-badge.high {
        background: #10b981;
      }
      .match-badge.medium {
        background: #f59e0b;
      }
      .match-badge.low {
        background: #ef4444;
      }

      .opportunity-details {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 1.5rem;
      }

      .detail-item {
        padding: 0.75rem;
        background: #f8f9fa;
        border-radius: 6px;
      }

      .detail-item strong {
        color: #666;
        font-size: 0.9rem;
        display: block;
        margin-bottom: 0.25rem;
      }

      .match-analysis {
        background: #e6f7ee;
        border: 1px solid #a3e9c0;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1.5rem;
      }

      .match-analysis h4 {
        color: #0a7b3e;
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .match-reasons {
        color: #0a7b3e;
        line-height: 1.6;
      }

      .ai-suggestions {
        background: #e6f3ff;
        border: 1px solid #a3d0ff;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1.5rem;
      }

      .ai-suggestions h4 {
        color: #1e40af;
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .ai-suggestions ul {
        list-style: none;
        padding-left: 0;
        color: #1e40af;
      }

      .ai-suggestions li {
        padding: 0.25rem 0;
        display: flex;
        align-items: flex-start;
        gap: 0.5rem;
      }

      .ai-suggestions li i {
        margin-top: 0.2rem;
        flex-shrink: 0;
      }

      .opportunity-actions {
        display: flex;
        gap: 1rem;
        justify-content: flex-end;
      }

      .btn {
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        text-align: center;
      }

      .btn-primary {
        background: #2d2dff;
        color: white;
      }

      .btn-primary:hover {
        background: #1a1aff;
        transform: translateY(-2px);
      }

      .btn-secondary {
        background: #f8f9fa;
        color: #333;
        border: 2px solid #e0e0e0;
      }

      .btn-secondary:hover {
        background: #e9ecef;
      }

      .btn-small {
        padding: 0.5rem 1rem;
        font-size: 0.9rem;
      }

      .loading {
        text-align: center;
        padding: 3rem;
      }

      .spinner {
        border: 4px solid rgba(0, 0, 0, 0.1);
        border-left-color: #2d2dff;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 1rem;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      .no-results {
        text-align: center;
        padding: 3rem;
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      }

      .criteria-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-top: 1rem;
      }

      .criteria-tag {
        background: #e0e7ff;
        color: #3730a3;
        padding: 0.25rem 0.75rem;
        border-radius: 15px;
        font-size: 0.8rem;
        font-weight: 500;
      }

      .funding-type-indicator {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        margin-top: 0.5rem;
        font-size: 0.9rem;
        color: #666;
      }

      .funding-type-indicator i {
        color: #2d2dff;
      }

      /* Application Modal Styles */
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        align-items: center;
        justify-content: center;
        padding: 1rem;
      }

      .modal.active {
        display: flex;
      }

      .modal-content {
        background: white;
        padding: 2rem;
        border-radius: 12px;
        width: 90%;
        max-width: 700px;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
      }

      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid #e0e0e0;
      }

      .modal-header h2 {
        color: #2d2dff;
        font-size: 1.5rem;
      }

      .close-modal {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: #666;
        padding: 0.5rem;
      }

      .close-modal:hover {
        color: #333;
      }

      .application-info {
        background: #f8f9fa;
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 1.5rem;
      }

      .application-info h3 {
        color: #2d2dff;
        margin-bottom: 0.5rem;
      }

      .form-group {
        margin-bottom: 1.5rem;
      }

      .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 600;
        color: #444;
      }

      .form-group input,
      .form-group textarea {
        width: 100%;
        padding: 0.75rem;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        font-size: 1rem;
        transition: border-color 0.3s;
        background: #fafafa;
      }

      .form-group input:focus,
      .form-group textarea:focus {
        outline: none;
        border-color: #2d2dff;
        background: #fff;
      }

      .form-group textarea {
        resize: vertical;
        min-height: 100px;
        font-family: "Inter", sans-serif;
      }

      .ai-generated-section {
        background: #f0f9ff;
        border: 1px solid #bae6fd;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
      }

      .ai-generated-section h4 {
        color: #0369a1;
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .ai-generated-text {
        background: #f8fafc;
        padding: 1rem;
        border-radius: 6px;
        min-height: 120px;
        white-space: pre-wrap;
        border: 1px solid #e0e0e0;
        font-size: 0.9rem;
        line-height: 1.6;
      }
      .ai-generated-text.editable {
        background: #fff !important;
        border: 2px solid #2d2dff !important;
        resize: vertical;
        font-family: "Inter", sans-serif;
        font-size: 0.9rem;
        line-height: 1.6;
        padding: 1rem;
        border-radius: 6px;
        min-height: 120px;
        width: 100%;
        box-sizing: border-box;
        white-space: pre-wrap;
      }

      .ai-generated-text.editable:focus {
        outline: none;
        border-color: #2d2dff;
        box-shadow: 0 0 0 3px rgba(45, 45, 255, 0.1);
      }

      /* File Upload Styles */
      .file-upload-section {
        margin-bottom: 1.5rem;
      }

      .file-upload-area {
        border: 2px dashed #cbd5e1;
        border-radius: 8px;
        padding: 2rem;
        text-align: center;
        background: #f8fafc;
        transition: all 0.3s;
        cursor: pointer;
      }

      .file-upload-area:hover {
        border-color: #2d2dff;
        background: #f0f9ff;
      }

      .file-upload-area.dragover {
        border-color: #2d2dff;
        background: #e0f2fe;
      }

      .file-upload-icon {
        font-size: 2rem;
        color: #64748b;
        margin-bottom: 1rem;
      }

      .file-input {
        display: none;
      }

      .file-list {
        margin-top: 1rem;
        max-height: 200px;
        overflow-y: auto;
      }

      .file-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0.75rem;
        background: white;
        border: 1px solid #e2e8f0;
        border-radius: 6px;
        margin-bottom: 0.5rem;
      }

      .file-info {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        flex: 1;
      }

      .file-icon {
        color: #ef4444;
        font-size: 1.2rem;
      }

      .file-name {
        font-weight: 500;
        color: #374151;
      }

      .file-size {
        color: #6b7280;
        font-size: 0.8rem;
      }

      .file-remove {
        background: none;
        border: none;
        color: #ef4444;
        cursor: pointer;
        padding: 0.25rem;
        border-radius: 4px;
      }

      .file-remove:hover {
        background: #fef2f2;
      }

      .upload-hint {
        color: #6b7280;
        font-size: 0.8rem;
        margin-top: 0.5rem;
      }

      .terms-checkbox {
        display: flex;
        align-items: flex-start;
        gap: 0.5rem;
        margin-bottom: 1.5rem;
      }

      .terms-checkbox input {
        margin-top: 0.2rem;
      }

      .terms-checkbox label {
        font-size: 0.9rem;
        color: #666;
        line-height: 1.4;
      }

      .form-actions {
        display: flex;
        gap: 1rem;
      }

      .btn-full {
        width: 100%;
        justify-content: center;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .opportunity-card {
        animation: fadeIn 0.5s ease-in;
      }
      @media (max-width: 768px) {
        .header {
          flex-direction: column;
          gap: 1rem;
          padding: 1rem;
        }

        .nav-links {
          gap: 0.5rem;
        }

        .nav-links a {
          padding: 0.5rem;
          font-size: 0.9rem;
        }

        .main-content {
          padding: 1rem;
        }

        .opportunity-header {
          flex-direction: column;
          gap: 1rem;
        }

        .opportunity-actions {
          flex-direction: column;
        }

        .criteria-grid {
          grid-template-columns: 1fr;
        }

        .matching-stats {
          grid-template-columns: repeat(2, 1fr);
        }

        .modal-content {
          padding: 1.5rem;
        }

        .form-actions {
          flex-direction: column;
        }

        .file-upload-area {
          padding: 1.5rem;
        }
      }
    </style>
  </head>
  <body>
    <!-- Header -->
    <div class="header">
      <div class="logo">
        <i class="fas fa-hand-holding-usd"></i>
        FundFinder
      </div>
      <div class="nav-links">
        <a href="smme-dashboard.html">Dashboard</a>
        <a href="smme-profile.html">My Profile</a>
        <a href="smme-funding-opportunities.html" class="active"
          >Find Opportunities</a
        >
        <a href="smme-applications.html">My Applications</a>
      </div>
      <div class="user-menu">
        <div class="user-info">
          <div class="user-avatar" id="user-avatar">S</div>
          <div class="user-details">
            <div class="user-name" id="userName">Welcome!</div>
          </div>
        </div>
        <button class="logout-btn" onclick="logout()">
          <i class="fas fa-sign-out-alt"></i> Logout
        </button>
      </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
      <div class="page-header">
        <h1>ü§ñ AI-Powered Funding Matches</h1>
        <p>
          Our AI analyzes your business criteria to find the perfect funding
          opportunities
        </p>
      </div>

      <!-- Business Profile Summary -->
      <div class="profile-summary">
        <h2><i class="fas fa-building"></i> Your Business Criteria</h2>
        <div id="profileCriteria">
          <!-- Will be populated by JavaScript -->
        </div>
        <div class="profile-actions">
          <a href="smme-profile.html" class="btn btn-secondary btn-small">
            <i class="fas fa-edit"></i> Update Criteria
          </a>
        </div>
      </div>

      <!-- AI Matching Header -->
      <div
        class="ai-matching-header"
        id="aiMatchingHeader"
        style="display: none"
      >
        <h2><i class="fas fa-robot"></i> AI Matching Results</h2>
        <p>
          Based on your business criteria, here are your best funding matches
        </p>
        <div class="matching-stats" id="matchingStats">
          <!-- Stats will be populated here -->
        </div>
      </div>

      <!-- Funding Opportunities -->
      <div class="opportunities-container" id="opportunitiesContainer">
        <div class="loading" id="loading">
          <div class="spinner"></div>
          <p>
            ü§ñ AI is analyzing your criteria and finding the best funding
            matches...
          </p>
          <p>
            <small
              >This may take a few moments as we analyze criteria
              matching</small
            >
          </p>
        </div>
      </div>
    </div>

    <!-- Application Modal -->
    <div id="applicationModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2 id="modalTitle">Apply for Funding</h2>
          <button class="close-modal" onclick="closeApplicationModal()">
            &times;
          </button>
        </div>

        <div class="application-info" id="applicationInfo">
          <!-- Funding opportunity info will be loaded here -->
        </div>

        <form id="applicationForm">
          <div class="form-group">
            <label for="requestedAmount">Requested Amount (ZAR) *</label>
            <input
              type="number"
              id="requestedAmount"
              name="requestedAmount"
              required
              placeholder="Enter the amount you're requesting"
            />
          </div>

          <!-- AI-Generated Project Summary -->
          <!-- AI-Generated Project Summary -->
          <div class="ai-generated-section">
            <h4><i class="fas fa-robot"></i> AI-Generated Project Summary</h4>
            <textarea
              class="ai-generated-text editable"
              id="projectSummaryText"
              placeholder="AI is generating your project summary..."
            ></textarea>
            <button
              type="button"
              class="btn btn-secondary btn-full"
              onclick="regenerateProjectSummary()"
              style="margin-top: 0.5rem"
            >
              <i class="fas fa-sync-alt"></i> Regenerate Project Summary
            </button>
          </div>

          <!-- AI-Generated Motivation Letter -->
          <div class="ai-generated-section">
            <h4><i class="fas fa-robot"></i> AI-Generated Motivation Letter</h4>
            <textarea
              class="ai-generated-text editable"
              id="motivationText"
              placeholder="AI is generating your motivation letter..."
            ></textarea>
            <button
              type="button"
              class="btn btn-secondary btn-full"
              onclick="regenerateMotivation()"
              style="margin-top: 0.5rem"
            >
              <i class="fas fa-sync-alt"></i> Regenerate Motivation Letter
            </button>
          </div>

          <!-- File Upload Section -->
          <div class="file-upload-section">
            <label>Supporting Documents (PDF files only)</label>
            <div
              class="file-upload-area"
              id="fileUploadArea"
              onclick="document.getElementById('fileInput').click()"
            >
              <div class="file-upload-icon">
                <i class="fas fa-cloud-upload-alt"></i>
              </div>
              <h4>Upload Supporting Documents</h4>
              <p>Click to browse or drag and drop PDF files here</p>
              <p class="upload-hint">
                Maximum 5 files ‚Ä¢ PDF only ‚Ä¢ 10MB per file
              </p>
              <input
                type="file"
                id="fileInput"
                class="file-input"
                accept=".pdf"
                multiple
                onchange="handleFileSelect(event)"
              />
            </div>
            <div class="file-list" id="fileList">
              <!-- Uploaded files will appear here -->
            </div>
          </div>

          <div class="terms-checkbox">
            <input
              type="checkbox"
              id="termsAccepted"
              name="termsAccepted"
              required
            />
            <label for="termsAccepted">
              I accept the terms and conditions and confirm the information
              provided is accurate. I understand that this application will be
              reviewed by the funding provider and that supporting documents are
              for review purposes only.
            </label>
          </div>

          <div class="form-actions">
            <button
              type="button"
              class="btn btn-secondary btn-full"
              onclick="closeApplicationModal()"
            >
              Cancel
            </button>
            <button type="submit" class="btn btn-primary btn-full">
              <i class="fas fa-paper-plane"></i> Submit Application
            </button>
          </div>
        </form>
      </div>
    </div>

    <script>
      // Configuration
      const GEMINI_API_KEY = "AIzaSyCixpv02sanUBs4YqxX6p8CrMfeQeVToyg";
      const SUPABASE_URL = "https://ovvvwbtexnbxzacizokr.supabase.co";
      const SUPABASE_ANON_KEY =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im92dnZ3YnRleG5ieHphY2l6b2tyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM1ODQ5OTEsImV4cCI6MjA3OTE2MDk5MX0.Ii21cw1Iyops8Zo784P-25NKz2m-TCyJ2zWwI4V1kcE";

      console.log("üöÄ Initializing Supabase client...");
      const supabase = window.supabase.createClient(
        SUPABASE_URL,
        SUPABASE_ANON_KEY
      );

      // DOM elements
      const profileCriteria = document.getElementById("profileCriteria");
      const opportunitiesContainer = document.getElementById(
        "opportunitiesContainer"
      );
      const loading = document.getElementById("loading");
      const aiMatchingHeader = document.getElementById("aiMatchingHeader");
      const matchingStats = document.getElementById("matchingStats");
      const userName = document.getElementById("userName");
      const userAvatar = document.getElementById("user-avatar");
      const applicationModal = document.getElementById("applicationModal");
      const modalTitle = document.getElementById("modalTitle");
      const applicationInfo = document.getElementById("applicationInfo");
      const applicationForm = document.getElementById("applicationForm");
      const motivationText = document.getElementById("motivationText");
      const projectSummaryText = document.getElementById("projectSummaryText");
      const fileUploadArea = document.getElementById("fileUploadArea");
      const fileInput = document.getElementById("fileInput");
      const fileList = document.getElementById("fileList");

      // Global variables
      let currentUser = null;
      let currentProfile = null;
      let currentFundingOpportunity = null;
      let allFundingOpportunities = [];
      let uploadedFiles = [];

      // Check authentication and load data
      document.addEventListener("DOMContentLoaded", async () => {
        console.log("üìÑ Page loaded, starting authentication check...");
        await checkAuth();
        await loadProfileAndOpportunities();

        // Initialize file upload drag and drop
        initializeFileUpload();
      });

      async function checkAuth() {
        console.log("üîê Checking authentication...");
        const userData = localStorage.getItem("fundfinder_user");

        if (!userData) {
          console.log("‚ùå No user data found, redirecting to login...");
          window.location.href = "login.html";
          return;
        }

        const user = JSON.parse(userData);
        currentUser = user;
        userName.textContent = user.email.split("@")[0];
        userAvatar.textContent = user.email.charAt(0).toUpperCase();
        console.log("‚úÖ User authenticated:", user.email);
      }

      async function loadProfileAndOpportunities() {
        console.log("üìä Loading profile and opportunities...");
        const userData = JSON.parse(localStorage.getItem("fundfinder_user"));

        try {
          // Load SMME profile with criteria
          console.log("üë§ Loading SMME profile with criteria...");
          const { data: profile, error: profileError } = await supabase
            .from("smmes")
            .select("*")
            .eq("user_id", userData.id)
            .single();

          if (profileError || !profile) {
            console.log(
              "‚ùå No profile found, redirecting to profile creation..."
            );
            window.location.href = "smme-profile.html";
            return;
          }

          console.log("‚úÖ Profile loaded:", profile.business_name);
          currentProfile = profile;
          displayProfileCriteria(profile);

          // Load funding opportunities with criteria
          console.log("üí∞ Loading funding opportunities with criteria...");
          const { data: fundingOpportunities, error: fundingError } =
            await supabase.from("funding").select("*");

          if (fundingError) {
            console.error(
              "‚ùå Error loading funding opportunities:",
              fundingError
            );
            throw fundingError;
          }

          console.log(
            `‚úÖ Loaded ${fundingOpportunities.length} funding opportunities`
          );
          allFundingOpportunities = fundingOpportunities;

          // Use REAL AI for intelligent matching - NO FALLBACK
          console.log("ü§ñ Starting REAL AI criteria matching...");
          const matchingResults = await matchWithRealAI(
            profile,
            fundingOpportunities
          );

          console.log("‚úÖ REAL AI matching completed:", matchingResults);

          // Display matching results
          displayMatchingResults(matchingResults);
          displayOpportunities(matchingResults.matchedOpportunities);
        } catch (error) {
          console.error("‚ùå Error loading data:", error);
          opportunitiesContainer.innerHTML = `
        <div class="no-results">
          <h3>AI Matching Unavailable</h3>
          <p>Real AI matching is currently unavailable. Please try again later.</p>
          <button class="btn btn-primary" onclick="location.reload()">
            <i class="fas fa-redo"></i> Retry AI Matching
          </button>
        </div>
      `;
        } finally {
          loading.style.display = "none";
          console.log("üèÅ Loading complete");
        }
      }

      function displayProfileCriteria(profile) {
        console.log("üìã Displaying profile criteria...");

        let criteriaHTML = "";

        if (profile.criteria) {
          criteriaHTML = `
        <div class="criteria-grid">
          ${
            profile.criteria.sector
              ? `
            <div class="criteria-item">
              <strong>Business Sector</strong>
              <span>${profile.criteria.sector}</span>
            </div>
          `
              : ""
          }
          
          ${
            profile.criteria.region
              ? `
            <div class="criteria-item">
              <strong>Operating Region</strong>
              <span>${profile.criteria.region}</span>
            </div>
          `
              : ""
          }
          
          ${
            profile.criteria.funding_amount_min
              ? `
            <div class="criteria-item">
              <strong>Funding Needed</strong>
              <span>R${profile.criteria.funding_amount_min.toLocaleString()} - R${
                  profile.criteria.funding_amount_max
                    ? profile.criteria.funding_amount_max.toLocaleString()
                    : "Open"
                }</span>
            </div>
          `
              : ""
          }
          
          ${
            profile.criteria.business_stage
              ? `
            <div class="criteria-item">
              <strong>Business Stage</strong>
              <span>${profile.criteria.business_stage}</span>
            </div>
          `
              : ""
          }

          ${
            profile.criteria.employees
              ? `
            <div class="criteria-item">
              <strong>Employees</strong>
              <span>${profile.criteria.employees}</span>
            </div>
          `
              : ""
          }

          ${
            profile.criteria.years_in_operation
              ? `
            <div class="criteria-item">
              <strong>Years in Operation</strong>
              <span>${profile.criteria.years_in_operation}</span>
            </div>
          `
              : ""
          }
        </div>
      `;
        } else {
          criteriaHTML = `
        <div class="criteria-grid">
          <div class="criteria-item">
            <strong>Business Sector</strong>
            <span>${profile.business_sector}</span>
          </div>
          <div class="criteria-item">
            <strong>Operating Region</strong>
            <span>${profile.region}</span>
          </div>
          <div class="criteria-item">
            <strong>Years in Operation</strong>
            <span>${profile.years_in_operation} years</span>
          </div>
          <div class="criteria-item">
            <strong>Business Stage</strong>
            <span>${
              profile.years_in_operation > 3 ? "Established" : "Growing"
            }</span>
          </div>
          ${
            profile.number_of_employees
              ? `
            <div class="criteria-item">
              <strong>Employees</strong>
              <span>${profile.number_of_employees}</span>
            </div>
          `
              : ""
          }
        </div>
      `;
        }

        profileCriteria.innerHTML = criteriaHTML;
      }

      async function matchWithRealAI(profile, opportunities) {
        console.log("üîç Starting REAL AI matching with progressive loading...");

        const matchedOpportunities = [];

        // Clear loading and show initial message
        loading.innerHTML = `
    <div class="spinner"></div>
    <p>ü§ñ AI is analyzing ${opportunities.length} funding opportunities...</p>
    <p><small>Matches will appear below as they are processed</small></p>
  `;

        // Create a container for progressive results
        opportunitiesContainer.innerHTML = `
    <div id="progressContainer" style="text-align: center; padding: 2rem;">
      <h3>ü§ñ AI Matching in Progress</h3>
      <p>Analyzing opportunities one by one...</p>
      <div id="progressStats" style="margin: 1rem 0;">
        <div style="display: inline-block; background: #e0e7ff; padding: 0.5rem 1rem; border-radius: 20px; margin: 0 0.5rem;">
          <strong>0</strong> / ${opportunities.length}
        </div>
        <div style="display: inline-block; background: #f0f9ff; padding: 0.5rem 1rem; border-radius: 20px; margin: 0 0.5rem;">
          <strong>0</strong> matches found
        </div>
      </div>
    </div>
    <div id="liveResults"></div>
  `;

        const progressContainer = document.getElementById("progressContainer");
        const progressStats = document.getElementById("progressStats");
        const liveResults = document.getElementById("liveResults");

        let processedCount = 0;
        let matchesFound = 0;

        for (const opportunity of opportunities) {
          if (!opportunity.criteria) {
            processedCount++;
            updateProgress(processedCount, opportunities.length, matchesFound);
            continue;
          }

          try {
            const aiMatchResult = await getRealAIMatchAnalysis(
              profile,
              opportunity
            );

            if (aiMatchResult.matchScore >= 20) {
              const matchedOpportunity = {
                ...opportunity,
                ...aiMatchResult,
              };
              matchedOpportunities.push(matchedOpportunity);
              matchesFound++;

              // Immediately display this match
              displaySingleOpportunity(matchedOpportunity, liveResults);
            }

            processedCount++;
            updateProgress(processedCount, opportunities.length, matchesFound);
          } catch (error) {
            console.error(
              `‚ùå REAL AI matching failed for opportunity ${opportunity.id}:`,
              error
            );
            processedCount++;
            updateProgress(processedCount, opportunities.length, matchesFound);
            continue;
          }

          // Small delay to make progressive loading more visible (optional)
          await new Promise((resolve) => setTimeout(resolve, 100));
        }

        console.log(
          `‚úÖ REAL AI matching found ${matchedOpportunities.length} opportunities`
        );

        // Final update when all processing is complete
        if (matchedOpportunities.length === 0) {
          progressContainer.innerHTML = `
      <div style="text-align: center; padding: 2rem;">
        <h3>ü§ñ AI Analysis Complete</h3>
        <p>No strong matches found. Try updating your business criteria.</p>
        <div style="margin-top: 1rem;">
          <a href="smme-profile.html" class="btn btn-primary">
            <i class="fas fa-edit"></i> Update Criteria
          </a>
        </div>
      </div>
    `;
        } else {
          progressContainer.innerHTML = `
      <div style="text-align: center; padding: 1rem; background: #f0f9ff; border-radius: 8px; margin: 1rem 0;">
        <h4>‚úÖ AI Analysis Complete!</h4>
        <p>Found ${matchedOpportunities.length} matching opportunities</p>
      </div>
    `;
        }

        return {
          totalOpportunities: opportunities.length,
          matchedCount: matchedOpportunities.length,
          averageMatchScore:
            matchedOpportunities.length > 0
              ? matchedOpportunities.reduce(
                  (sum, opp) => sum + opp.matchScore,
                  0
                ) / matchedOpportunities.length
              : 0,
          matchedOpportunities: matchedOpportunities.sort(
            (a, b) => b.matchScore - a.matchScore
          ),
        };
      }

      function updateProgress(processed, total, matches) {
        const progressStats = document.getElementById("progressStats");
        if (progressStats) {
          progressStats.innerHTML = `
      <div style="display: inline-block; background: #e0e7ff; padding: 0.5rem 1rem; border-radius: 20px; margin: 0 0.5rem;">
        <strong>${processed}</strong> / ${total} processed
      </div>
      <div style="display: inline-block; background: #f0f9ff; padding: 0.5rem 1rem; border-radius: 20px; margin: 0 0.5rem;">
        <strong>${matches}</strong> matches found
      </div>
    `;
        }
      }

      function displaySingleOpportunity(opportunity, container) {
        const matchLevel = getMatchLevel(opportunity.matchScore);
        const fundingBadge = getFundingTypeBadge(opportunity);
        const fundingIcon = getFundingTypeIcon(opportunity);

        const opportunityElement = document.createElement("div");
        opportunityElement.innerHTML = `
    <div class="opportunity-card ${
      matchLevel.level
    }-match" style="animation: fadeIn 0.5s ease-in;">
      ${
        fundingBadge
          ? `
        <div class="opportunity-badge ${fundingBadge.class}">
          ${fundingBadge.label}
        </div>
      `
          : ""
      }
      
      <div class="opportunity-header">
        <div class="opportunity-title">
          <h3><i class="${fundingIcon}"></i> ${opportunity.name}</h3>
          <p>${opportunity.description || "No description available"}</p>
          <div class="funding-type-indicator">
            <i class="fas fa-tag"></i>
            ${getFundingTypeDescription(opportunity)}
          </div>
        </div>
        <div class="match-badge ${matchLevel.level}">
          ${opportunity.matchScore}% AI Match
        </div>
      </div>

      <div class="opportunity-details">
        ${
          opportunity.criteria?.funding_amount_min
            ? `
          <div class="detail-item">
            <strong>Funding Range</strong>
            <span>R${opportunity.criteria.funding_amount_min.toLocaleString()} - R${
                opportunity.criteria.funding_amount_max
                  ? opportunity.criteria.funding_amount_max.toLocaleString()
                  : "Open"
              }</span>
          </div>
        `
            : ""
        }
        
        ${
          opportunity.criteria?.sector
            ? `
          <div class="detail-item">
            <strong>Sector Focus</strong>
            <span>${
              opportunity.criteria.sector.charAt(0).toUpperCase() +
              opportunity.criteria.sector.slice(1)
            }</span>
          </div>
        `
            : ""
        }
        
        ${
          opportunity.criteria?.region
            ? `
          <div class="detail-item">
            <strong>Region Focus</strong>
            <span>${
              opportunity.criteria.region.charAt(0).toUpperCase() +
              opportunity.criteria.region.slice(1)
            }</span>
          </div>
        `
            : ""
        }
        
        ${
          opportunity.criteria?.business_stage
            ? `
          <div class="detail-item">
            <strong>Business Stage</strong>
            <span>${
              opportunity.criteria.business_stage.charAt(0).toUpperCase() +
              opportunity.criteria.business_stage.slice(1)
            }</span>
          </div>
        `
            : ""
        }
      </div>

      <div class="match-analysis">
        <h4><i class="fas fa-robot"></i> REAL AI Analysis</h4>
        <div class="match-reasons">${opportunity.matchReasoning}</div>
      </div>

      <div class="ai-suggestions">
        <h4><i class="fas fa-lightbulb"></i> AI Application Strategy</h4>
        <ul>
          ${opportunity.aiSuggestions
            .map(
              (suggestion) =>
                `<li><i class="fas fa-check"></i> ${suggestion}</li>`
            )
            .join("")}
        </ul>
      </div>

      <div class="opportunity-actions">
        <button class="btn btn-secondary" onclick="viewDetails('${
          opportunity.id
        }')">
          <i class="fas fa-info-circle"></i> View Details
        </button>
        <button class="btn btn-primary" onclick="applyForFunding('${
          opportunity.id
        }')">
          <i class="fas fa-paper-plane"></i> Apply Now
        </button>
      </div>
    </div>
  `;

        // Add fade-in animation
        container.appendChild(opportunityElement);
      }

      async function getRealAIMatchAnalysis(profile, opportunity) {
        console.log(`ü§ñ REAL AI analyzing match for: ${opportunity.name}`);

        const prompt = `
CRITICAL: You MUST respond with ONLY valid JSON. No other text.

Analyze the compatibility between this business and funding opportunity. Provide a JSON response with:
- matchScore (0-100)
- matchReasoning (string explaining key compatibility factors)
- aiSuggestions (array of 3 application tips)

BUSINESS PROFILE:
- Name: ${profile.business_name}
- Sector: ${profile.business_sector}
- Region: ${profile.region}
- Years in Operation: ${profile.years_in_operation}
- Employees: ${profile.number_of_employees}
- Business Stage: ${profile.criteria?.business_stage || "Not specified"}
- Funding Need: R${
          profile.criteria?.funding_amount_min || "Not specified"
        } - R${profile.criteria?.funding_amount_max || "Open"}
- Project: ${profile.project_description}

FUNDING OPPORTUNITY:
- Name: ${opportunity.name}
- Description: ${opportunity.description}
- Sector Focus: ${opportunity.criteria?.sector || "Any"}
- Region Focus: ${opportunity.criteria?.region || "National"}
- Business Stage: ${opportunity.criteria?.business_stage || "Any"}
- Funding Range: ${opportunity.criteria?.amount_range || "Not specified"}
- Requirements: ${opportunity.criteria?.requirements || "None"}

Consider sector alignment, regional fit, business stage compatibility, funding amount appropriateness, and overall strategic fit. Be realistic but encouraging.

RESPONSE FORMAT (JSON ONLY):
{
  "matchScore": 85,
  "matchReasoning": "Strong sector alignment and regional fit...",
  "aiSuggestions": ["Tip 1", "Tip 2", "Tip 3"]
}
`;

        try {
          // Using the latest Gemini 2.0 Flash model with correct API structure
          const response = await fetch(
            `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}`,
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                contents: [
                  {
                    parts: [
                      {
                        text: prompt,
                      },
                    ],
                  },
                ],
                generationConfig: {
                  temperature: 0.3,
                  maxOutputTokens: 800,
                },
              }),
            }
          );

          if (!response.ok) {
            const errorText = await response.text();
            console.error("‚ùå AI API Error Response:", errorText);
            throw new Error(
              `AI API request failed: ${response.status} - ${errorText}`
            );
          }

          const data = await response.json();

          if (
            !data.candidates ||
            !data.candidates[0] ||
            !data.candidates[0].content
          ) {
            console.error("‚ùå Invalid AI response structure:", data);
            throw new Error("Invalid AI response structure");
          }

          const aiResponse = data.candidates[0].content.parts[0].text;
          console.log("ü§ñ Raw AI Response:", aiResponse);

          // Clean the response and extract JSON
          const cleanedResponse = aiResponse
            .replace(/```json\s*|\s*```/g, "")
            .trim();
          const jsonMatch = cleanedResponse.match(/\{[\s\S]*\}/);

          if (!jsonMatch) {
            console.error("‚ùå No JSON found in AI response:", cleanedResponse);
            throw new Error("No valid JSON in AI response");
          }

          const result = JSON.parse(jsonMatch[0]);

          // Validate required fields
          if (
            typeof result.matchScore !== "number" ||
            typeof result.matchReasoning !== "string" ||
            !Array.isArray(result.aiSuggestions)
          ) {
            throw new Error(
              "Invalid AI response format - missing required fields"
            );
          }

          console.log(`‚úÖ REAL AI match score: ${result.matchScore}%`);
          return result;
        } catch (error) {
          console.error("‚ùå REAL AI API Error:", error);
          throw error; // Re-throw to skip this opportunity
        }
      }

      function getFundingTypeBadge(opportunity) {
        const criteria = opportunity.criteria || {};

        if (criteria.owner_gender === "female") {
          return { type: "special", label: "Women-Focused", class: "special" };
        }
        if (criteria.owner_age_max === 35) {
          return { type: "special", label: "Youth Program", class: "special" };
        }
        if (criteria.region && criteria.region !== "national") {
          return {
            type: "regional",
            label: "Regional Fund",
            class: "regional",
          };
        }
        if (criteria.sector && criteria.sector !== "any") {
          return { type: "sector", label: "Sector-Specific", class: "sector" };
        }

        return null;
      }

      function getFundingTypeIcon(opportunity) {
        const criteria = opportunity.criteria || {};
        const name = opportunity.name.toLowerCase();

        if (criteria.owner_gender === "female") return "fas fa-female";
        if (criteria.owner_age_max === 35) return "fas fa-user-graduate";
        if (name.includes("tech") || name.includes("innovation"))
          return "fas fa-laptop-code";
        if (name.includes("agriculture") || name.includes("farming"))
          return "fas fa-tractor";
        if (name.includes("tourism") || name.includes("hospitality"))
          return "fas fa-hotel";
        if (name.includes("health") || name.includes("medical"))
          return "fas fa-heartbeat";
        if (name.includes("energy") || name.includes("green"))
          return "fas fa-bolt";
        if (name.includes("manufacturing")) return "fas fa-industry";

        return "fas fa-hand-holding-usd";
      }

      function displayMatchingResults(results) {
        console.log("üìä Displaying matching results...");
        aiMatchingHeader.style.display = "block";

        matchingStats.innerHTML = `
      <div class="stat-item">
        <div class="stat-value">${results.totalOpportunities}</div>
        <div class="stat-label">Total Opportunities</div>
      </div>
      <div class="stat-item">
        <div class="stat-value">${results.matchedCount}</div>
        <div class="stat-label">AI Matches Found</div>
      </div>
      <div class="stat-item">
        <div class="stat-value">${Math.round(results.averageMatchScore)}%</div>
        <div class="stat-label">Avg AI Match Score</div>
      </div>
      <div class="stat-item">
        <div class="stat-value">${Math.round(
          (results.matchedCount / results.totalOpportunities) * 100
        )}%</div>
        <div class="stat-label">AI Match Rate</div>
      </div>
    `;
      }

      function displayOpportunities(opportunities) {
        console.log(
          "üéØ Displaying REAL AI matched opportunities:",
          opportunities.length
        );

        if (opportunities.length === 0) {
          console.log("‚ùå No REAL AI matches found");
          opportunitiesContainer.innerHTML = `
        <div class="no-results">
          <h3>ü§ñ No AI Matches Found</h3>
          <p>Our real AI analysis couldn't find strong matches for your business criteria. This could be because:</p>
          <ul style="text-align: left; margin: 1rem 0;">
            <li>Your business criteria are very specific</li>
            <li>Current funding opportunities don't align with your profile</li>
            <li>Try updating your business profile with broader criteria</li>
          </ul>
          <div style="display: flex; gap: 1rem; justify-content: center; margin-top: 1.5rem;">
            <a href="smme-profile.html" class="btn btn-primary">
              <i class="fas fa-edit"></i> Update Business Criteria
            </a>
            <button class="btn btn-secondary" onclick="location.reload()">
              <i class="fas fa-robot"></i> Retry AI Analysis
            </button>
          </div>
        </div>
      `;
          return;
        }

        opportunitiesContainer.innerHTML = opportunities
          .map((opp) => {
            const matchLevel = getMatchLevel(opp.matchScore);
            const fundingBadge = getFundingTypeBadge(opp);
            const fundingIcon = getFundingTypeIcon(opp);

            return `
        <div class="opportunity-card ${matchLevel.level}-match">
          ${
            fundingBadge
              ? `
            <div class="opportunity-badge ${fundingBadge.class}">
              ${fundingBadge.label}
            </div>
          `
              : ""
          }
          
          <div class="opportunity-header">
            <div class="opportunity-title">
              <h3><i class="${fundingIcon}"></i> ${opp.name}</h3>
              <p>${opp.description || "No description available"}</p>
              <div class="funding-type-indicator">
                <i class="fas fa-tag"></i>
                ${getFundingTypeDescription(opp)}
              </div>
            </div>
            <div class="match-badge ${matchLevel.level}">
              ${opp.matchScore}% AI Match
            </div>
          </div>

          <div class="opportunity-details">
            ${
              opp.criteria?.funding_amount_min
                ? `
              <div class="detail-item">
                <strong>Funding Range</strong>
                <span>R${opp.criteria.funding_amount_min.toLocaleString()} - R${
                    opp.criteria.funding_amount_max
                      ? opp.criteria.funding_amount_max.toLocaleString()
                      : "Open"
                  }</span>
              </div>
            `
                : ""
            }
            
            ${
              opp.criteria?.sector
                ? `
              <div class="detail-item">
                <strong>Sector Focus</strong>
                <span>${
                  opp.criteria.sector.charAt(0).toUpperCase() +
                  opp.criteria.sector.slice(1)
                }</span>
              </div>
            `
                : ""
            }
            
            ${
              opp.criteria?.region
                ? `
              <div class="detail-item">
                <strong>Region Focus</strong>
                <span>${
                  opp.criteria.region.charAt(0).toUpperCase() +
                  opp.criteria.region.slice(1)
                }</span>
              </div>
            `
                : ""
            }
            
            ${
              opp.criteria?.business_stage
                ? `
              <div class="detail-item">
                <strong>Business Stage</strong>
                <span>${
                  opp.criteria.business_stage.charAt(0).toUpperCase() +
                  opp.criteria.business_stage.slice(1)
                }</span>
              </div>
            `
                : ""
            }
          </div>

          <div class="match-analysis">
            <h4><i class="fas fa-robot"></i> REAL AI Analysis</h4>
            <div class="match-reasons">${opp.matchReasoning}</div>
          </div>

          <div class="ai-suggestions">
            <h4><i class="fas fa-lightbulb"></i> AI Application Strategy</h4>
            <ul>
              ${opp.aiSuggestions
                .map(
                  (suggestion) =>
                    `<li><i class="fas fa-check"></i> ${suggestion}</li>`
                )
                .join("")}
            </ul>
          </div>

          <div class="opportunity-actions">
            <button class="btn btn-secondary" onclick="viewDetails('${
              opp.id
            }')">
              <i class="fas fa-info-circle"></i> View Details
            </button>
            <button class="btn btn-primary" onclick="applyForFunding('${
              opp.id
            }')">
              <i class="fas fa-paper-plane"></i> Apply Now
            </button>
          </div>
        </div>
      `;
          })
          .join("");
      }

      function getFundingTypeDescription(opportunity) {
        const criteria = opportunity.criteria || {};

        if (criteria.owner_gender === "female")
          return "Women Entrepreneurship Support";
        if (criteria.owner_age_max === 35) return "Youth Development Program";
        if (criteria.region && criteria.region !== "national")
          return `${
            criteria.region.charAt(0).toUpperCase() + criteria.region.slice(1)
          } Regional Fund`;
        if (criteria.sector && criteria.sector !== "any")
          return `${
            criteria.sector.charAt(0).toUpperCase() + criteria.sector.slice(1)
          } Sector Focus`;

        return "General Business Funding";
      }

      function getMatchLevel(score) {
        if (score >= 75) return { level: "high", label: "Perfect AI Match" };
        if (score >= 50) return { level: "medium", label: "Strong AI Match" };
        return { level: "low", label: "Good AI Match" };
      }

      function viewDetails(opportunityId) {
        console.log("üîç Viewing details for:", opportunityId);
        const opportunity = allFundingOpportunities.find(
          (opp) => opp.id === opportunityId
        );
        if (opportunity) {
          const criteria = opportunity.criteria || {};
          const details = `
Funding Opportunity: ${opportunity.name}
Description: ${opportunity.description}

Criteria:
- Funding Range: ${criteria.amount_range || "Not specified"}
- Sector: ${criteria.sector || "Any"}
- Region: ${criteria.region || "National"}
- Business Stage: ${criteria.business_stage || "Any"}

Requirements: ${criteria.requirements || "None specified"}
      `;
          alert(details);
        }
      }

      // Initialize file upload with drag and drop
      function initializeFileUpload() {
        fileUploadArea.addEventListener("dragover", (e) => {
          e.preventDefault();
          fileUploadArea.classList.add("dragover");
        });

        fileUploadArea.addEventListener("dragleave", (e) => {
          e.preventDefault();
          fileUploadArea.classList.remove("dragover");
        });

        fileUploadArea.addEventListener("drop", (e) => {
          e.preventDefault();
          fileUploadArea.classList.remove("dragover");
          const files = e.dataTransfer.files;
          handleFiles(files);
        });
      }

      function handleFileSelect(event) {
        const files = event.target.files;
        handleFiles(files);
      }

      function handleFiles(files) {
        const maxFiles = 5;
        const maxSize = 10 * 1024 * 1024;

        if (uploadedFiles.length + files.length > maxFiles) {
          alert(`You can only upload up to ${maxFiles} files.`);
          return;
        }

        for (let file of files) {
          if (file.type !== "application/pdf") {
            alert(
              `"${file.name}" is not a PDF file. Please upload PDF files only.`
            );
            continue;
          }

          if (file.size > maxSize) {
            alert(`"${file.name}" is too large. Maximum file size is 10MB.`);
            continue;
          }

          uploadedFiles.push(file);
          addFileToList(file);
        }

        fileInput.value = "";
      }

      function addFileToList(file) {
        const fileItem = document.createElement("div");
        fileItem.className = "file-item";

        const fileSize = (file.size / (1024 * 1024)).toFixed(2) + " MB";

        fileItem.innerHTML = `
      <div class="file-info">
        <i class="fas fa-file-pdf file-icon"></i>
        <div>
          <div class="file-name">${file.name}</div>
          <div class="file-size">${fileSize}</div>
        </div>
      </div>
      <button type="button" class="file-remove" onclick="removeFile('${file.name}')">
        <i class="fas fa-times"></i>
      </button>
    `;

        fileList.appendChild(fileItem);
      }

      function removeFile(fileName) {
        uploadedFiles = uploadedFiles.filter((file) => file.name !== fileName);
        fileList.innerHTML = "";
        uploadedFiles.forEach((file) => addFileToList(file));
      }

      async function generateProjectSummary(opportunity) {
        projectSummaryText.innerHTML = `
  <div class="loading">
    <div class="spinner" style="width: 20px; height: 20px;"></div>
    <p>AI is generating your project summary...</p>
  </div>
`;

        try {
          const prompt = `
Create a concise 150-200 word project summary for a funding application with these details:

BUSINESS: ${currentProfile.business_name} - ${
            currentProfile.business_sector
          } in ${currentProfile.region}
EXPERIENCE: ${currentProfile.years_in_operation} years in business, ${
            currentProfile.number_of_employees || "several"
          } employees
PROJECT: ${currentProfile.project_description}
FUNDING USE: ${currentProfile.fund_usage}
OPPORTUNITY: ${opportunity.name} - ${opportunity.description}

Write a professional project summary that:
1. Clearly states the project objectives
2. Highlights the expected outcomes and impact
3. Shows alignment with the funding opportunity
4. Demonstrates business capability
5. Is concise and compelling

Focus on clarity, impact, and alignment with the funding criteria.
      `;

          // Using the latest Gemini 2.0 Flash model
          const response = await fetch(
            `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}`,
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                contents: [
                  {
                    parts: [
                      {
                        text: prompt,
                      },
                    ],
                  },
                ],
              }),
            }
          );

          if (response.ok) {
            const data = await response.json();
            const summary = data.candidates[0].content.parts[0].text;
            projectSummaryText.value = summary;
          } else {
            throw new Error("AI API failed");
          }
        } catch (error) {
          console.error("Error generating project summary:", error);
          projectSummaryText.textContent =
            "AI content generation failed. Please write your project summary manually.";
        }
      }

      async function generateMotivationLetter(opportunity) {
        motivationText.value = "AI is generating your motivation letter...";

        try {
          const prompt = `
Create a professional funding application motivation letter with these details:

BUSINESS: ${currentProfile.business_name} - ${
            currentProfile.business_sector
          } in ${currentProfile.region}
EXPERIENCE: ${currentProfile.years_in_operation} years, ${
            currentProfile.number_of_employees || "team of"
          } employees
PROJECT: ${currentProfile.project_description}
FUNDING USE: ${currentProfile.fund_usage}
OPPORTUNITY: ${opportunity.name}

Write a compelling 250-300 word motivation letter that:
1. Introduces the business professionally
2. Explains alignment with the funding opportunity
3. Highlights qualifications and experience
4. Describes project impact and benefits
5. Shows commitment and capability

Use professional tone and focus on creating sustainable impact.
      `;

          // Using the latest Gemini 2.0 Flash model
          const response = await fetch(
            `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}`,
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                contents: [
                  {
                    parts: [
                      {
                        text: prompt,
                      },
                    ],
                  },
                ],
              }),
            }
          );

          if (response.ok) {
            const data = await response.json();
            const letter = data.candidates[0].content.parts[0].text;
            motivationText.value = letter;
          } else {
            throw new Error("AI API failed");
          }
        } catch (error) {
          console.error("Error generating motivation letter:", error);
          motivationText.textContent =
            "AI content generation failed. Please write your motivation letter manually.";
        }
      }

      async function regenerateProjectSummary() {
        if (currentFundingOpportunity) {
          await generateProjectSummary(currentFundingOpportunity);
        }
      }

      async function regenerateMotivation() {
        if (currentFundingOpportunity) {
          await generateMotivationLetter(currentFundingOpportunity);
        }
      }

      async function applyForFunding(opportunityId) {
        console.log("üìù Applying for funding:", opportunityId);

        const opportunity = allFundingOpportunities.find(
          (opp) => opp.id === opportunityId
        );
        if (!opportunity) {
          alert("Funding opportunity not found");
          return;
        }

        currentFundingOpportunity = opportunity;

        const { data: funder } = await supabase
          .from("users")
          .select("email")
          .eq("id", opportunity.funder_id)
          .single();

        modalTitle.textContent = `Apply for: ${opportunity.name}`;
        applicationInfo.innerHTML = `
      <h3>${opportunity.name}</h3>
      <p><strong>Funder:</strong> ${funder?.email || "Unknown"}</p>
      <p><strong>Description:</strong> ${
        opportunity.description || "No description available"
      }</p>
      ${
        opportunity.criteria?.amount_range
          ? `<p><strong>Funding Range:</strong> ${opportunity.criteria.amount_range}</p>`
          : ""
      }
    `;

        applicationForm.reset();
        uploadedFiles = [];
        fileList.innerHTML = "";

        await generateProjectSummary(opportunity);
        await generateMotivationLetter(opportunity);

        applicationModal.classList.add("active");
      }

      function closeApplicationModal() {
        applicationModal.classList.remove("active");
        currentFundingOpportunity = null;
        uploadedFiles = [];
        fileList.innerHTML = "";
      }

      applicationForm.addEventListener("submit", async (e) => {
        e.preventDefault();

        if (!currentFundingOpportunity) {
          alert("No funding opportunity selected");
          return;
        }

        const formData = new FormData(applicationForm);
        const applicationData = {
          requestedAmount: formData.get("requestedAmount"),
          projectSummary: projectSummaryText.value,
          motivationLetter: motivationText.value,
          termsAccepted: formData.get("termsAccepted") === "on",
          uploadedFiles: uploadedFiles.map((file) => ({
            name: file.name,
            size: file.size,
            type: file.type,
          })),
        };

        if (
          !applicationData.requestedAmount ||
          !applicationData.termsAccepted
        ) {
          alert(
            "Please fill in all required fields and accept the terms and conditions"
          );
          return;
        }

        try {
          const applicationRecord = {
            smme_id: currentUser.id,
            funder_id: currentFundingOpportunity.funder_id,
            funding_id: currentFundingOpportunity.id,
            form_data: {
              requestedAmount: applicationData.requestedAmount,
              projectSummary: applicationData.projectSummary,
              motivationLetter: applicationData.motivationLetter,
              uploadedDocuments: applicationData.uploadedFiles,
              businessName: currentProfile.business_name,
              businessSector: currentProfile.business_sector,
              region: currentProfile.region,
              submittedAt: new Date().toISOString(),
            },
            status: "Submitted",
          };

          const { data, error } = await supabase
            .from("applications")
            .insert([applicationRecord])
            .select();

          if (error) throw error;

          alert(
            "üéâ Application submitted successfully!\n\nYour application has been sent to the funder for review. You can track its progress in the 'My Applications' section."
          );

          closeApplicationModal();
          setTimeout(() => {
            window.location.href = "smme-applications.html";
          }, 2000);
        } catch (error) {
          console.error("Error submitting application:", error);
          alert("Error submitting application. Please try again.");
        }
      });

      function logout() {
        console.log("üö™ Logging out...");
        localStorage.removeItem("fundfinder_user");
        window.location.href = "login.html";
      }

      window.onclick = function (event) {
        if (event.target === applicationModal) {
          closeApplicationModal();
        }
      };

      // Make functions globally available
      window.viewDetails = viewDetails;
      window.applyForFunding = applyForFunding;
      window.regenerateProjectSummary = regenerateProjectSummary;
      window.regenerateMotivation = regenerateMotivation;
      window.removeFile = removeFile;
      window.handleFileSelect = handleFileSelect;
      window.closeApplicationModal = closeApplicationModal;
      window.logout = logout;
    </script>
  </body>
</html>
