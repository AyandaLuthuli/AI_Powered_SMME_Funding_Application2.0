<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>FundFinder - Complete Your Business Profile</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Inter", sans-serif;
        line-height: 1.6;
        color: #333;
        background: #f5f7fa;
        min-height: 100vh;
      }

      /* Header */
      .header {
        background: #fff;
        padding: 1rem 2rem;
        border-bottom: 1px solid #e0e0e0;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      .logo {
        font-weight: 700;
        font-size: 1.8rem;
        color: #2d2dff;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .nav-links {
        display: flex;
        gap: 2rem;
        align-items: center;
      }

      .nav-links a {
        color: #333;
        text-decoration: none;
        font-weight: 500;
        padding: 0.5rem 1rem;
        border-radius: 8px;
        transition: all 0.3s;
      }

      .nav-links a:hover,
      .nav-links a.active {
        background: #2d2dff;
        color: white;
      }

      .user-menu {
        display: flex;
        align-items: center;
        gap: 1rem;
      }

      .logout-btn {
        background: #ff4757;
        color: white;
        border: none;
        padding: 0.6rem 1.2rem;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s;
      }

      .logout-btn:hover {
        background: #ff3742;
        transform: translateY(-2px);
      }

      /* Main Content */
      .main-content {
        max-width: 1000px;
        margin: 0 auto;
        padding: 2rem;
      }

      .profile-container {
        background: #fff;
        padding: 3rem;
        border-radius: 20px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
      }

      .profile-header {
        text-align: center;
        margin-bottom: 2.5rem;
      }

      .profile-header h1 {
        color: #2d2dff;
        margin-bottom: 0.5rem;
        font-size: 2.5rem;
      }

      .profile-header p {
        color: #666;
        font-size: 1.2rem;
      }

      .progress-section {
        background: #f8f9fa;
        padding: 2rem;
        border-radius: 15px;
        margin-bottom: 2.5rem;
      }

      .progress-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
      }

      .progress-header h3 {
        color: #333;
        font-size: 1.3rem;
      }

      .progress-percentage {
        font-weight: 700;
        color: #2d2dff;
        font-size: 1.2rem;
      }

      .progress-bar {
        background: #e0e0e0;
        height: 10px;
        border-radius: 5px;
        overflow: hidden;
      }

      .progress {
        background: linear-gradient(135deg, #2d2dff, #667eea);
        height: 100%;
        width: 0%;
        transition: width 0.5s ease;
      }

      .form-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1.5rem;
        margin-bottom: 2rem;
      }

      .form-group {
        margin-bottom: 1.5rem;
      }

      .form-group.full-width {
        grid-column: 1 / -1;
      }

      label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 600;
        color: #444;
      }

      .required::after {
        content: " *";
        color: #e53e3e;
      }

      input,
      select,
      textarea {
        width: 100%;
        padding: 1rem 1.2rem;
        border: 2px solid #e0e0e0;
        border-radius: 10px;
        font-size: 1rem;
        transition: all 0.3s;
        background: #fafafa;
      }

      input:focus,
      select:focus,
      textarea:focus {
        border-color: #2d2dff;
        background: #fff;
        outline: none;
        box-shadow: 0 0 0 3px rgba(45, 45, 255, 0.1);
      }

      textarea {
        resize: vertical;
        min-height: 120px;
        font-family: "Inter", sans-serif;
      }

      .form-actions {
        display: flex;
        justify-content: flex-end;
        gap: 1rem;
        margin-top: 2rem;
        padding-top: 2rem;
        border-top: 1px solid #e0e0e0;
      }

      .btn {
        padding: 1rem 2.5rem;
        border: none;
        border-radius: 10px;
        font-size: 1.1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .btn-primary {
        background: #2d2dff;
        color: white;
      }

      .btn-primary:hover {
        background: #1a1aff;
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(45, 45, 255, 0.3);
      }

      .btn-secondary {
        background: #f8f9fa;
        color: #333;
        border: 2px solid #e0e0e0;
      }

      .btn-secondary:hover {
        background: #e9ecef;
        transform: translateY(-2px);
      }

      .message {
        padding: 1.5rem;
        border-radius: 10px;
        margin-bottom: 1.5rem;
        display: none;
        font-weight: 500;
      }

      .message.success {
        background: #e6f7ee;
        color: #0a7b3e;
        border: 1px solid #a3e9c0;
        display: block;
      }

      .message.error {
        background: #fde8e8;
        color: #c53030;
        border: 1px solid #feb2b2;
        display: block;
      }

      .loading {
        display: none;
        text-align: center;
        padding: 2rem;
      }

      .loading.active {
        display: block;
      }

      .spinner {
        border: 4px solid rgba(0, 0, 0, 0.1);
        border-left-color: #2d2dff;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 1rem;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      @media (max-width: 768px) {
        .header {
          flex-direction: column;
          gap: 1rem;
          padding: 1rem;
        }

        .nav-links {
          gap: 0.5rem;
        }

        .nav-links a {
          padding: 0.5rem;
          font-size: 0.9rem;
        }

        .main-content {
          padding: 1rem;
        }

        .profile-container {
          padding: 2rem;
        }

        .form-grid {
          grid-template-columns: 1fr;
        }

        .form-actions {
          flex-direction: column;
        }

        .btn {
          width: 100%;
          justify-content: center;
        }
      }
    </style>
  </head>
  <body>
    <!-- Header -->
    <div class="header">
      <div class="logo">
        <i class="fas fa-hand-holding-usd"></i>
        FundFinder
      </div>
      <div class="nav-links">
        <a href="smme-dashboard.html">Dashboard</a>
        <a href="smme-profile.html" class="active">My Profile</a>
        <a href="smme-funding-opportunities.html">Find Opportunities</a>
        <a href="smme-applications.html">My Applications</a>
      </div>
      <div class="user-menu">
        <button class="logout-btn" onclick="logout()">
          <i class="fas fa-sign-out-alt"></i> Logout
        </button>
      </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
      <div class="profile-container">
        <div class="profile-header">
          <h1>Complete Your Business Profile</h1>
          <p>
            Tell us about your business to unlock personalized funding matches
          </p>
        </div>

        <!-- Progress Section -->
        <div class="progress-section">
          <div class="progress-header">
            <h3>Profile Completion</h3>
            <div class="progress-percentage" id="progressPercentage">0%</div>
          </div>
          <div class="progress-bar">
            <div class="progress" id="progressBar"></div>
          </div>
          <p style="margin-top: 1rem; color: #666; font-size: 0.9rem">
            Complete your profile to increase your chances of funding approval
            by up to 70%
          </p>
        </div>

        <div class="message" id="message"></div>
        <div class="loading" id="loading">
          <div class="spinner"></div>
          <p>Saving your profile...</p>
        </div>

        <form id="businessProfileForm">
          <div class="form-grid">
            <!-- Business Information -->
            <div class="form-group">
              <label for="businessName" class="required">Business Name</label>
              <input
                type="text"
                id="businessName"
                required
                placeholder="Enter your official business name"
              />
            </div>

            <div class="form-group">
              <label for="ownerName">Owner Name</label>
              <input
                type="text"
                id="ownerName"
                placeholder="Full name of business owner"
              />
            </div>

            <div class="form-group">
              <label for="registrationNumber">Registration Number</label>
              <input
                type="text"
                id="registrationNumber"
                placeholder="CIPC/Company registration number"
              />
            </div>

            <div class="form-group">
              <label for="businessSector" class="required"
                >Business Sector</label
              >
              <select id="businessSector" required>
                <option value="">Select Your Industry</option>
                <option value="Agriculture">Agriculture & Farming</option>
                <option value="Technology">Technology & IT</option>
                <option value="Manufacturing">Manufacturing</option>
                <option value="Retail">Retail & E-commerce</option>
                <option value="Services">Professional Services</option>
                <option value="Construction">Construction</option>
                <option value="Tourism">Tourism & Hospitality</option>
                <option value="Healthcare">Healthcare</option>
                <option value="Education">Education</option>
                <option value="Creative">Creative Industries</option>
                <option value="Other">Other</option>
              </select>
            </div>

            <div class="form-group">
              <label for="region" class="required">Region/Province</label>
              <select id="region" required>
                <option value="">Select Your Region</option>
                <option value="Eastern Cape">Eastern Cape</option>
                <option value="Free State">Free State</option>
                <option value="Gauteng">Gauteng</option>
                <option value="KwaZulu-Natal">KwaZulu-Natal</option>
                <option value="Limpopo">Limpopo</option>
                <option value="Mpumalanga">Mpumalanga</option>
                <option value="Northern Cape">Northern Cape</option>
                <option value="North West">North West</option>
                <option value="Western Cape">Western Cape</option>
              </select>
            </div>

            <div class="form-group">
              <label for="yearsInOperation" class="required"
                >Years in Operation</label
              >
              <input
                type="number"
                id="yearsInOperation"
                min="0"
                max="50"
                required
                placeholder="How many years has your business been operating?"
              />
            </div>

            <div class="form-group">
              <label for="annualRevenue">Annual Revenue (ZAR)</label>
              <input
                type="number"
                id="annualRevenue"
                min="0"
                step="1000"
                placeholder="Estimated annual revenue in Rands"
              />
            </div>

            <div class="form-group">
              <label for="numberOfEmployees">Number of Employees</label>
              <input
                type="number"
                id="numberOfEmployees"
                min="0"
                placeholder="Current number of employees"
              />
            </div>
          </div>

          <!-- Text Areas - Full Width -->
          <div class="form-group full-width">
            <label for="businessDescription" class="required"
              >Business Description</label
            >
            <textarea
              id="businessDescription"
              placeholder="Describe your business, products, services, and unique value proposition..."
              required
            ></textarea>
          </div>

          <div class="form-group full-width">
            <label for="projectDescription" class="required"
              >Project Description</label
            >
            <textarea
              id="projectDescription"
              placeholder="Describe the specific project or initiative you need funding for. Include goals, timeline, and expected outcomes..."
              required
            ></textarea>
          </div>

          <div class="form-group full-width">
            <label for="fundUsage" class="required"
              >How will you use the funds?</label
            >
            <textarea
              id="fundUsage"
              placeholder="Provide a detailed breakdown of how you plan to use the funding (equipment, marketing, salaries, etc.)..."
              required
            ></textarea>
          </div>

          <div class="form-actions">
            <button
              type="button"
              class="btn btn-secondary"
              onclick="saveProfile()"
            >
              <i class="fas fa-save"></i> Save Profile
            </button>
            <button type="submit" class="btn btn-primary">
              <i class="fas fa-search-dollar"></i> Find Funding Opportunities
            </button>
          </div>
        </form>
      </div>
    </div>

    <script>
      // Supabase configuration
      const SUPABASE_URL = "https://ovvvwbtexnbxzacizokr.supabase.co";
      const SUPABASE_ANON_KEY =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im92dnZ3YnRleG5ieHphY2l6b2tyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM1ODQ5OTEsImV4cCI6MjA3OTE2MDk5MX0.Ii21cw1Iyops8Zo784P-25NKz2m-TCyJ2zWwI4V1kcE";

      const supabase = window.supabase.createClient(
        SUPABASE_URL,
        SUPABASE_ANON_KEY
      );

      // DOM elements
      const form = document.getElementById("businessProfileForm");
      const message = document.getElementById("message");
      const loading = document.getElementById("loading");
      const progressBar = document.getElementById("progressBar");
      const progressPercentage = document.getElementById("progressPercentage");

      // Check authentication and load existing data
      document.addEventListener("DOMContentLoaded", async () => {
        await checkAuth();
        await loadExistingProfile();
      });

      async function checkAuth() {
        const userData = localStorage.getItem("fundfinder_user");

        if (!userData) {
          window.location.href = "login.html";
          return;
        }

        const user = JSON.parse(userData);
        if (user.role !== "SMME") {
          window.location.href = "index.html";
          return;
        }
      }

      async function loadExistingProfile() {
        const userData = JSON.parse(localStorage.getItem("fundfinder_user"));

        try {
          const { data: profile, error } = await supabase
            .from("smmes")
            .select("*")
            .eq("user_id", userData.id)
            .single();

          if (profile && !error) {
            // Pre-fill form with existing data
            document.getElementById("businessName").value =
              profile.business_name || "";
            document.getElementById("ownerName").value =
              profile.owner_name || "";
            document.getElementById("registrationNumber").value =
              profile.registration_number || "";
            document.getElementById("businessSector").value =
              profile.business_sector || "";
            document.getElementById("region").value = profile.region || "";
            document.getElementById("yearsInOperation").value =
              profile.years_in_operation || "";
            document.getElementById("annualRevenue").value =
              profile.annual_revenue || "";
            document.getElementById("numberOfEmployees").value =
              profile.number_of_employees || "";
            document.getElementById("businessDescription").value =
              profile.business_description || "";
            document.getElementById("projectDescription").value =
              profile.project_description || "";
            document.getElementById("fundUsage").value =
              profile.fund_usage || "";

            updateProgressBar();
          }
        } catch (error) {
          console.log("No existing profile found");
        }
      }

      function updateProgressBar() {
        const fields = [
          "businessName",
          "businessSector",
          "region",
          "yearsInOperation",
          "businessDescription",
          "projectDescription",
          "fundUsage",
        ];

        let completed = 0;
        fields.forEach((field) => {
          const value = document.getElementById(field).value;
          if (value && value.trim() !== "") {
            completed++;
          }
        });

        const progress = (completed / fields.length) * 100;
        progressBar.style.width = `${progress}%`;
        progressPercentage.textContent = `${Math.round(progress)}%`;
      }

      // Update progress bar as user types
      document
        .querySelectorAll("input, select, textarea")
        .forEach((element) => {
          element.addEventListener("input", updateProgressBar);
        });

      // Form submission
      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        await saveProfile(true); // true indicates redirect after save
      });

      async function saveProfile(redirect = false) {
        const userData = JSON.parse(localStorage.getItem("fundfinder_user"));
        const formData = {
          user_id: userData.id,
          business_name: document.getElementById("businessName").value,
          owner_name: document.getElementById("ownerName").value,
          registration_number:
            document.getElementById("registrationNumber").value,
          business_sector: document.getElementById("businessSector").value,
          region: document.getElementById("region").value,
          years_in_operation: parseInt(
            document.getElementById("yearsInOperation").value
          ),
          annual_revenue: document.getElementById("annualRevenue").value
            ? parseFloat(document.getElementById("annualRevenue").value)
            : null,
          number_of_employees: document.getElementById("numberOfEmployees")
            .value
            ? parseInt(document.getElementById("numberOfEmployees").value)
            : null,
          business_description: document.getElementById("businessDescription")
            .value,
          project_description:
            document.getElementById("projectDescription").value,
          fund_usage: document.getElementById("fundUsage").value,
        };

        // Validate required fields
        if (
          !formData.business_name ||
          !formData.business_sector ||
          !formData.region ||
          !formData.years_in_operation ||
          !formData.business_description ||
          !formData.project_description ||
          !formData.fund_usage
        ) {
          showMessage("Please fill in all required fields", "error");
          return;
        }

        loading.classList.add("active");

        try {
          // Check if profile already exists
          const { data: existingProfile } = await supabase
            .from("smmes")
            .select("id")
            .eq("user_id", userData.id)
            .single();

          let result;
          if (existingProfile) {
            // Update existing profile
            result = await supabase
              .from("smmes")
              .update(formData)
              .eq("user_id", userData.id);
          } else {
            // Insert new profile
            result = await supabase.from("smmes").insert([formData]);
          }

          if (result.error) throw result.error;

          showMessage(
            "Profile saved successfully!" +
              (redirect ? " Redirecting to funding opportunities..." : ""),
            "success"
          );

          if (redirect) {
            // Redirect to funding opportunities page
            setTimeout(() => {
              window.location.href = "smme-funding-opportunities.html";
            }, 2000);
          }
        } catch (error) {
          console.error("Error saving profile:", error);
          showMessage("Error saving profile: " + error.message, "error");
        } finally {
          loading.classList.remove("active");
        }
      }

      function showMessage(text, type) {
        message.textContent = text;
        message.className = `message ${type}`;
      }

      function logout() {
        localStorage.removeItem("fundfinder_user");
        window.location.href = "login.html";
      }
    </script>
  </body>
</html>
