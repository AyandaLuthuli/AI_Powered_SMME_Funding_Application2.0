<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>My Business Profile - FundFinder</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Inter", sans-serif;
        line-height: 1.6;
        color: #333;
        background: #f5f7fa;
      }

      .header {
        background: #fff;
        padding: 1rem 2rem;
        border-bottom: 1px solid #e0e0e0;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .logo {
        font-weight: 700;
        font-size: 1.5rem;
        color: #2d2dff;
      }

      .nav-links {
        display: flex;
        gap: 2rem;
      }

      .nav-links a {
        color: #333;
        text-decoration: none;
        font-weight: 500;
        transition: color 0.3s;
      }

      .nav-links a:hover,
      .nav-links a.active {
        color: #2d2dff;
      }

      .user-menu {
        display: flex;
        align-items: center;
        gap: 1rem;
      }

      .logout-btn {
        background: #2d2dff;
        color: white;
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 5px;
        cursor: pointer;
      }

      .main-content {
        max-width: 800px;
        margin: 0 auto;
        padding: 2rem;
      }

      .page-header {
        text-align: center;
        margin-bottom: 2rem;
      }

      .page-header h1 {
        color: #2d2dff;
        font-size: 2.5rem;
        margin-bottom: 0.5rem;
      }

      .page-header p {
        color: #666;
        font-size: 1.1rem;
      }

      .profile-form {
        background: #fff;
        padding: 2rem;
        border-radius: 12px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      }

      .form-group {
        margin-bottom: 1.5rem;
      }

      .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 600;
        color: #333;
      }

      .form-group input,
      .form-group select,
      .form-group textarea {
        width: 100%;
        padding: 0.75rem;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        font-size: 1rem;
        transition: border-color 0.3s;
      }

      .form-group input:focus,
      .form-group select:focus,
      .form-group textarea:focus {
        outline: none;
        border-color: #2d2dff;
      }

      .form-group textarea {
        resize: vertical;
        min-height: 100px;
      }

      .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
      }

      .btn {
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        text-decoration: none;
        display: inline-block;
        text-align: center;
      }

      .btn-primary {
        background: #2d2dff;
        color: white;
      }

      .btn-primary:hover {
        background: #1a1aff;
        transform: translateY(-2px);
      }

      .btn-secondary {
        background: #f8f9fa;
        color: #333;
        border: 2px solid #e0e0e0;
      }

      .btn-secondary:hover {
        background: #e9ecef;
      }

      .form-actions {
        display: flex;
        gap: 1rem;
        justify-content: flex-end;
        margin-top: 2rem;
      }

      .loading {
        text-align: center;
        padding: 2rem;
      }

      .spinner {
        border: 4px solid rgba(0, 0, 0, 0.1);
        border-left-color: #2d2dff;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 1rem;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      .success-message {
        background: #d4edda;
        color: #155724;
        padding: 1rem;
        border-radius: 8px;
        border: 1px solid #c3e6cb;
        margin-bottom: 1rem;
      }

      .error-message {
        background: #f8d7da;
        color: #721c24;
        padding: 1rem;
        border-radius: 8px;
        border: 1px solid #f5c6cb;
        margin-bottom: 1rem;
      }

      @media (max-width: 768px) {
        .header {
          flex-direction: column;
          gap: 1rem;
          padding: 1rem;
        }

        .nav-links {
          gap: 1rem;
        }

        .main-content {
          padding: 1rem;
        }

        .form-row {
          grid-template-columns: 1fr;
        }

        .form-actions {
          flex-direction: column;
        }
      }
    </style>
  </head>
  <body>
    <!-- Header -->
    <div class="header">
      <div class="logo">FundFinder</div>
      <div class="nav-links">
        <a href="funding-opportunities.html">Funding Opportunities</a>
        <a href="smme-dashboard.html">My Applications</a>
        <a href="#" class="active">My Profile</a>
      </div>
      <div class="user-menu">
        <div class="user-info">
          <div class="user-name" id="userName">Welcome!</div>
        </div>
        <button class="logout-btn" onclick="logout()">Logout</button>
      </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
      <div class="page-header">
        <h1>üè¢ Business Profile</h1>
        <p>
          Complete your business profile to get personalized funding
          recommendations
        </p>
      </div>

      <div class="profile-form">
        <div id="messageContainer"></div>

        <form id="profileForm">
          <div class="form-group">
            <label for="businessName">Business Name *</label>
            <input type="text" id="businessName" name="businessName" required />
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="ownerName">Owner Name</label>
              <input
                type="text"
                id="ownerName"
                name="ownerName"
                placeholder="Optional"
              />
            </div>

            <div class="form-group">
              <label for="registrationNumber">Registration Number</label>
              <input
                type="text"
                id="registrationNumber"
                name="registrationNumber"
                placeholder="Optional"
              />
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="businessSector">Business Sector *</label>
              <select id="businessSector" name="businessSector" required>
                <option value="">Select Sector</option>
                <option value="Technology">Technology</option>
                <option value="Agriculture">Agriculture</option>
                <option value="Manufacturing">Manufacturing</option>
                <option value="Retail">Retail</option>
                <option value="Services">Services</option>
                <option value="Tourism">Tourism</option>
                <option value="Healthcare">Healthcare</option>
                <option value="Education">Education</option>
                <option value="Construction">Construction</option>
                <option value="Transportation">Transportation</option>
                <option value="Food & Beverage">Food & Beverage</option>
                <option value="Creative Industries">Creative Industries</option>
                <option value="Renewable Energy">Renewable Energy</option>
                <option value="Other">Other</option>
              </select>
            </div>

            <div class="form-group">
              <label for="region">Region/Province *</label>
              <select id="region" name="region" required>
                <option value="">Select Region</option>
                <option value="Gauteng">Gauteng</option>
                <option value="Western Cape">Western Cape</option>
                <option value="KwaZulu-Natal">KwaZulu-Natal</option>
                <option value="Eastern Cape">Eastern Cape</option>
                <option value="Free State">Free State</option>
                <option value="Limpopo">Limpopo</option>
                <option value="Mpumalanga">Mpumalanga</option>
                <option value="North West">North West</option>
                <option value="Northern Cape">Northern Cape</option>
                <option value="National">National (Multiple Regions)</option>
              </select>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="yearsInOperation">Years in Operation *</label>
              <input
                type="number"
                id="yearsInOperation"
                name="yearsInOperation"
                min="0"
                max="50"
                required
              />
            </div>

            <div class="form-group">
              <label for="numberOfEmployees">Number of Employees</label>
              <input
                type="number"
                id="numberOfEmployees"
                name="numberOfEmployees"
                min="0"
              />
            </div>
          </div>

          <div class="form-group">
            <label for="annualRevenue">Annual Revenue (R)</label>
            <input
              type="number"
              id="annualRevenue"
              name="annualRevenue"
              min="0"
              placeholder="e.g., 500000"
            />
          </div>

          <div class="form-group">
            <label for="businessDescription">Business Description *</label>
            <textarea
              id="businessDescription"
              name="businessDescription"
              required
              placeholder="Describe what your business does, your products/services, and your target market..."
            ></textarea>
          </div>

          <div class="form-group">
            <label for="projectDescription"
              >Project/Initiative Description *</label
            >
            <textarea
              id="projectDescription"
              name="projectDescription"
              required
              placeholder="Describe the specific project or initiative you need funding for..."
            ></textarea>
          </div>

          <div class="form-group">
            <label for="fundUsage">How will you use the funding? *</label>
            <textarea
              id="fundUsage"
              name="fundUsage"
              required
              placeholder="Explain exactly how you plan to use the funding (equipment, marketing, expansion, etc.)..."
            ></textarea>
          </div>

          <div class="form-actions">
            <button type="button" class="btn btn-secondary" onclick="goBack()">
              Cancel
            </button>
            <button type="submit" class="btn btn-primary" id="submitBtn">
              Save Profile
            </button>
          </div>
        </form>
      </div>

      <div class="loading" id="loading" style="display: none">
        <div class="spinner"></div>
        <p>Loading your profile...</p>
      </div>
    </div>

    <script>
      // === SUPABASE SETUP ===
      const SUPABASE_URL = "https://oybbsrrmggexrvkzzayf.supabase.co";
      const SUPABASE_KEY =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im95YmJzcnJtZ2dleHJ2a3p6YXlmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk5MTEyMjQsImV4cCI6MjA3NTQ4NzIyNH0.5whFAXrEFtFICWC6SZ0pBU6-WxmLMHidBfHFKcaTlc8";

      const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

      // DOM elements
      const profileForm = document.getElementById("profileForm");
      const loading = document.getElementById("loading");
      const messageContainer = document.getElementById("messageContainer");
      const userName = document.getElementById("userName");
      const submitBtn = document.getElementById("submitBtn");

      let currentUser = null;

      // Check authentication and load existing profile
      document.addEventListener("DOMContentLoaded", async () => {
        await checkAuth();
        await loadExistingProfile();
      });

      async function checkAuth() {
        const userData = localStorage.getItem("fundfinder_user");

        if (!userData) {
          window.location.href = "login.html";
          return;
        }

        currentUser = JSON.parse(userData);
        userName.textContent = `Welcome, ${currentUser.email}`;
      }

      async function loadExistingProfile() {
        console.log("üîç Loading existing SMME profile...");

        loading.style.display = "block";
        profileForm.style.display = "none";

        try {
          const { data: profile, error } = await supabase
            .from("smmes")
            .select("*")
            .eq("user_id", currentUser.id)
            .single();

          console.log("Profile query result:", { profile, error });

          if (error) {
            if (error.code === "PGRST116") {
              // No profile found - this is normal for new users
              console.log("No existing profile found - new user");
              showMessage(
                "üìù Please complete your business profile to get started.",
                "success"
              );
            } else {
              throw error;
            }
          } else if (profile) {
            // Populate form with existing data
            console.log("Populating form with profile data:", profile);

            document.getElementById("businessName").value =
              profile.business_name || "";
            document.getElementById("ownerName").value =
              profile.owner_name || "";
            document.getElementById("registrationNumber").value =
              profile.registration_number || "";
            document.getElementById("businessSector").value =
              profile.business_sector || "";
            document.getElementById("region").value = profile.region || "";
            document.getElementById("yearsInOperation").value =
              profile.years_in_operation || "";
            document.getElementById("numberOfEmployees").value =
              profile.number_of_employees || "";
            document.getElementById("annualRevenue").value =
              profile.annual_revenue || "";
            document.getElementById("businessDescription").value =
              profile.business_description || "";
            document.getElementById("projectDescription").value =
              profile.project_description || "";
            document.getElementById("fundUsage").value =
              profile.fund_usage || "";

            showMessage(
              "‚úÖ Your existing profile has been loaded. You can update it below.",
              "success"
            );
          }
        } catch (error) {
          console.error("Error loading profile:", error);
          showMessage(
            "‚ùå Error loading profile. Please refresh the page.",
            "error"
          );
        } finally {
          loading.style.display = "none";
          profileForm.style.display = "block";
        }
      }

      // Handle form submission
      profileForm.addEventListener("submit", async (e) => {
        e.preventDefault();

        const formData = new FormData(profileForm);

        const profileData = {
          user_id: currentUser.id,
          business_name: formData.get("businessName"),
          owner_name: formData.get("ownerName") || null,
          registration_number: formData.get("registrationNumber") || null,
          business_sector: formData.get("businessSector"),
          region: formData.get("region"),
          years_in_operation: parseInt(formData.get("yearsInOperation")),
          number_of_employees: formData.get("numberOfEmployees")
            ? parseInt(formData.get("numberOfEmployees"))
            : null,
          annual_revenue: formData.get("annualRevenue")
            ? parseFloat(formData.get("annualRevenue"))
            : null,
          business_description: formData.get("businessDescription"),
          project_description: formData.get("projectDescription"),
          fund_usage: formData.get("fundUsage"),
          updated_at: new Date().toISOString(),
        };
        +console.log("Saving profile data:", profileData);

        submitBtn.disabled = true;
        submitBtn.textContent = "Saving...";

        try {
          // Check if profile already exists
          const { data: existingProfile } = await supabase
            .from("smmes")
            .select("id")
            .eq("user_id", currentUser.id)
            .single();

          let result;
          if (existingProfile) {
            // Update existing profile
            console.log("Updating existing profile...");
            result = await supabase
              .from("smmes")
              .update(profileData)
              .eq("user_id", currentUser.id);
          } else {
            // Create new profile
            console.log("Creating new profile...");
            profileData.created_at = new Date().toISOString();
            result = await supabase.from("smmes").insert([profileData]);
          }

          console.log("Save result:", result);

          if (result.error) {
            throw result.error;
          }

          showMessage(
            "‚úÖ Profile saved successfully! You can now explore funding opportunities.",
            "success"
          );

          // Redirect to funding opportunities after 2 seconds
          setTimeout(() => {
            window.location.href = "funding-opportunities.html";
          }, 2000);
        } catch (error) {
          console.error("Error saving profile:", error);
          showMessage(`‚ùå Error saving profile: ${error.message}`, "error");
        } finally {
          submitBtn.disabled = false;
          submitBtn.textContent = "Save Profile";
        }
      });

      function showMessage(message, type) {
        messageContainer.innerHTML = `
                <div class="${
                  type === "success" ? "success-message" : "error-message"
                }">
                    ${message}
                </div>
            `;
      }

      function goBack() {
        window.location.href = "funding-opportunities.html";
      }

      function logout() {
        localStorage.removeItem("fundfinder_user");
        window.location.href = "login.html";
      }
    </script>
  </body>
</html>
